# План доработок калькулятора зарплаты логопеда

Этот план учитывает замеченные расхождения с требованиями из `docs/requirements.md` и уточнения по недавним доработкам. Приоритеты: сначала исправления, влияющие на корректность расчётов и базовые сценарии, затем расширения функционала, потом UX/доступность.

## Блок 0. Срочные исправления (прежде чем добавлять новый функционал)
1. **Синхронизировать значения по умолчанию** — ✅ выполнено
   - Привести дефолты к эталону: `a1=4, a2=0, a3=0`, `O_teacher_contract=31 869.33`, `use_extra_subst=false`, `H_sub_extra=0`, `K_OVZ=5`, `R_sub_extra=700`, `Class_type_subst` по умолчанию коррекционный, `C_stu=37`, `Weeks_year=34`, `Months_year=12`.
   - Проверить, что после сброса/инициализации блок разовых замен не добавляет выплаты.
   - Статус: дефолты обновлены и сброс выставляет значения из требований.
   - Файлы: `index.html` (объект defaults/инициализация), вспомогательные функции сброса.

2. **Починить переключатель режима ставки разовых замен** — ✅ выполнено
   - Значение радио «по ученико-часу» должно совпадать с проверкой в расчёте (`Subst_rate_mode = 'stu_hour'` или унифицированное значение).
   - Добавить тестовый сценарий: выбор режима ученико-часа, ввод `N_class_subst`/`Class_type_subst`, расчёт `R_sub_current` по формуле.
   - Статус: радиокнопки и расчёт теперь используют значение `stu_hour`, предупреждения обновлены.
   - Файлы: `index.html` (разметка радио, функция пересчёта).

3. **Использовать нормативный коэффициент 25 для коррекционного класса** — ✅ выполнено
   - В режиме ученико-часа ставка для коррекционных/малокомплектных классов: `R_sub_current = C_stu × 25`.
   - Обновить соответствующий коэффициент и тесты/примеры, убрать устаревший множитель 1.3.
   - Статус: коэффициент в расчёте установлен на 25 и используется при вычислении ставки по ученико-часу.
   - Файлы: `index.html` (константа коэффициента, расчёт разовых замен).

4. **Исключить двойной учёт замен** — ✅ выполнено
   - Отключить или удалить устаревший блок `use_substitution`, чтобы в gross попадала только требуемая сумма `Subst_extra`.
   - Убедиться, что лишние коэффициенты (`k_corr`, `k_subst`, `k_usl_subst`) не влияют на итоговый расчёт или вынести их в факультативные настройки.
   - Статус: базовый блок скрыт и отключён в логике расчёта; предупреждение под формой объясняет, что учитывается только «Дополнительное замещение».
   - Файлы: `index.html` (пересчёт итогов, UI блока замещений).

## Блок 1. Критичная логика по требованиям
1. **Базовый оклад логопеда** — ✅ выполнено
   - Поля: `O_logoped_base` и доля ставки `S_log` (диапазон 0–1, шаг 0.25).  
   - Формула: `Base_logoped = O_logoped_base × S_log`; добавить предупреждение при значении ниже МРОТ.  
   - Файлы: `index.html` (UI, расчёт), стили предупреждения.

2. **Учебная нагрузка (формула 3.9) и сравнение с договором** — ✅ выполнено
   - Добавить переключатель `use_teacher_load`.  
   - Поля состава класса `a1/a2/a3` (дефолты 4/0/0, целые ≥0, подсказка).  
   - Динамические строки нагрузки: предмет, `t_week`, `K_div`, `K_subj` с кнопками добавления/удаления и примером по умолчанию.  
   - Расчёт `K_total`, `O_line`, суммирование `O_teacher_calc`; отдельный ввод `O_teacher_contract` (31 869.33) и вывод разницы.  
   - Не включать `O_teacher_calc` в gross — использовать только для сравнения.  
   - Файлы: `index.html` (UI списка, функции расчёта, блок сравнения), возможная разбивка JS на функции.

3. **Разовые замены (требуемый блок)** — ✅ выполнено
   - Переключатель `use_extra_subst` (по умолчанию выключен).  
   - Поля: `H_sub_extra`, `Subst_rate_mode` (приказ/ученико-час), `R_sub_extra`, `N_class_subst`, `Class_type_subst`.  
   - Расчёты: `R_sub_current` по выбранному режиму; `Subst_extra = H_sub_extra × R_sub_current`; ставка по ученико-часу: обычный класс `C_stu × N_class_subst`, коррекционный `C_stu × 25`.  
   - Файлы: `index.html` (UI, расчёты, дефолты).

4. **Компенсации** — ✅ выполнено
   - Радио `OVZ_base_mode` (логопедическая база / логопедическая + учительская).
   - Поля: `% K_OVZ` (0–20, дефолт 5), `Comp_other`.
   - Расчёт `Comp_OVZ` от выбранной базы; `Comp_total = Comp_OVZ + Comp_other`.  
   - Файлы: `index.html` (UI, расчёт).

5. **Стимулирующие выплаты** — ✅ выполнено
   - Разделить на `Stim_month`, `Prem_month`, `Stim_other`, дефолты 3 000 / 0 / 0, сумма `Stim_total`.  
   - Файлы: `index.html` (UI, расчёт, сброс/копирование).

6. **Налоги и удержания** — ✅ выполнено
   - Поля: `Ndfl_rate` (0–100, дефолт 13), `Withhold_other`.  
   - Расчёты: `Ndfl_amount`, `Total_withhold`.  
   - Файлы: `index.html` (UI, расчёт), форматирование валют/процентов.

7. **Итоги** — ✅ выполнено
   - Показатели: `Gross_salary`, `Net_salary`, `Share_subst_percent`, `Subst_hour_net`.  
   - Gross включает `O_logoped_base × S_log + O_teacher_contract + Subst_extra + Comp_total + Stim_total`.  
   - Net = Gross − `Total_withhold`; при расчёте доли/цены часа учитывать `H_sub_extra` и `Subst_extra`.  
   - Файлы: `index.html` (итоговый блок, форматирование, sticky-позиционирование опционально).

## Блок 2. UX, валидация и доступность
1. **Макет и подсказки**  
   - Отдельные секции: общий блок, базовый оклад, учебная нагрузка, разовые замены, компенсации, стимулирующие, налоги, итоги, опционально помощь/глоссарий.  
   - Лейблы с единицами, иконки `?` для `C_stu`, состава класса, коэффициентов нагрузки, доплат.  
   - Кнопки «Сброс» и «Скопировать результаты» должны учитывать все поля и дефолты.  
   - Файлы: `index.html` (разметка), стили.

2. **Валидация**  
   - Диапазоны: деньги ≥0, проценты 0–100, доля ставки 0–1, часы/ученики ≥0.  
   - Предупреждения: сумма `a1+a2+a3=0` при ненулевой нагрузке, итоги <0, некорректные режимы.  
   - Визуальная подсветка ошибок, текстовые подсказки рядом с полями.  
   - Файлы: `index.html` (логика валидации, сообщения), стили ошибок.

3. **Форматирование, доступность, адаптивность**  
   - Использовать `toLocaleString('ru-RU')` для валют/чисел/процентов; пробел перед «₽».  
   - Добавить `aria-label/aria-describedby`, видимые фокусы, достаточный контраст.  
   - Проверить mobile-first (≥360 px), при необходимости сделать итоговый блок закреплённым.  
   - Файлы: `index.html` и стили.

## Блок 3. Дополнительно
1. **Раздел помощи/нормативки**  
   - Кратко описать формулы и ссылки на нормативные документы; сделать collapsible.  
   - Файлы: `index.html` (UI, текст), возможно отдельный JSON/JS для справки.

2. **Производительность**  
   - После расширения логики проверить время пересчёта (<150 мс); при необходимости мемоизация или оптимизация количества пересчётов.  
   - Файлы: `index.html` (разделение функций, оптимизация триггеров пересчёта).  

## Тестирование
- Юнит/интеграционные тесты отсутствуют; пока опираться на ручные сценарии: дефолтные значения, переключение режимов, крайние значения диапазонов, проверка формул для обычных и коррекционных классов, отключение блоков (`use_teacher_load`, `use_extra_subst`).
