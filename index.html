<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Калькулятор оплаты логопеда</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #1f2933;
      --accent: #2b7a78;
      --accent-soft: #def2f1;
      --border: #d9e2ec;
      --danger: #ef4e4e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 620px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .summary {
      background: linear-gradient(135deg, var(--accent), #3aafa9);
      color: #fff;
      border: none;
    }

    .summary-main {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .summary-details {
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.9;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 15px;
    }

    input[readonly], input:disabled, select:disabled {
      background: #f0f4f8;
      color: #738391;
      cursor: not-allowed;
    }

    input.invalid {
      border-color: var(--danger);
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .sub-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 12px;
    }

    details {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #f8fbff;
      padding: 10px 12px;
      margin-top: 8px;
    }

    details summary {
      cursor: pointer;
      font-weight: 700;
      list-style: none;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    .hidden {
      display: none;
    }

    .accordion-content {
      margin-top: 8px;
      line-height: 1.5;
      font-size: 14px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #f8fbff;
    }

    .teacher-overview {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .teacher-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .teacher-label {
      font-size: 13px;
      color: #52606d;
      font-weight: 600;
    }

    .teacher-badge {
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 700;
      background: var(--accent-soft);
      border: 1px solid var(--border);
      min-width: 120px;
      text-align: right;
    }

    .delta-positive {
      color: #0f9151;
      background: #e5f5ee;
      border-color: #c5eadc;
    }

    .delta-negative {
      color: var(--danger);
      background: #fde8e8;
      border-color: #facdcd;
    }

    .stat-label {
      font-size: 13px;
      color: #52606d;
      margin-bottom: 6px;
    }

    .stat-value {
      font-weight: 700;
      font-size: 18px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-secondary {
      background: var(--accent-soft);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .info {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 12px;
      font-weight: 700;
      position: relative;
      cursor: help;
      border: 1px solid var(--accent);
    }

    .info::after {
      content: attr(data-tooltip);
      position: absolute;
      top: 26px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      opacity: 0;
      visibility: hidden;
      width: max-content;
      max-width: 260px;
      font-weight: 500;
      z-index: 2;
      font-size: 12px;
    }

    .info:focus::after,
    .info:hover::after {
      opacity: 1;
      visibility: visible;
    }

    .muted {
      color: #52606d;
      font-size: 14px;
    }

    .warning-text {
      color: var(--danger);
      font-size: 14px;
      margin-top: -6px;
    }

    .flex-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Калькулятор оплаты логопеда</h1>
      <p class="muted">Расчёт месячной оплаты с учётом оклада, замещения, компенсаций и стимулирующих. Все суммы и часы вводятся сразу за месяц.</p>
    </header>

    <section class="summary" aria-live="polite">
      <div class="summary-main" id="total_display">Итоговая сумма за месяц: 0 ₽</div>
      <div class="summary-details" id="summary_breakdown"></div>
    </section>

    <section>
      <h2>Общие настройки</h2>
      <div class="field">
        <label for="system">Система расчёта</label>
        <input id="system" type="text" value="Москва (ученик-час = 37 ₽)" readonly>
      </div>
      <div class="field">
        <label for="period">Период расчёта</label>
        <input id="period" type="text" value="2025/2026" readonly>
      </div>
      <div class="field">
        <label for="organization">Организация</label>
        <input id="organization" type="text" value="ГБОУ Школа № 1400" readonly>
      </div>
      <div class="field">
        <label for="worker_category">Категория работника</label>
        <input id="worker_category" type="text" value="Иные педагогические работники (логопед/дефектолог)" readonly>
      </div>
      <div class="field">
        <label for="c_stu">Стоимость 1 ученико-часа (C_stu) <span class="info" tabindex="0" data-tooltip="Нормативная стоимость одного ученико-часа по приказу/Положению об оплате труда.">?</span></label>
        <input id="c_stu" type="number" min="0" step="1">
      </div>
      <div class="field">
        <label for="weeks_year">Количество учебных недель (Weeks_year)</label>
        <input id="weeks_year" type="number" min="1" max="52" step="1">
      </div>
      <div class="field">
        <label for="months_year">Количество месяцев в году (Months_year)</label>
        <input id="months_year" type="number" value="12" readonly>
      </div>
    </section>

    <section>
      <h2>Оклад логопеда</h2>
      <div class="field">
        <label for="t_logoped">Оклад логопеда за 1 ставку, ₽/месяц</label>
        <input id="t_logoped" type="number" min="0" step="100">
      </div>
      <div class="field">
        <label for="logoped_share">Доля ставки логопеда</label>
        <input id="logoped_share" type="number" min="0" max="1" step="0.25">
      </div>
      <div id="mrot_warning" class="warning-text" aria-live="polite"></div>
    </section>

    <section>
      <h2>Учебная нагрузка как учитель</h2>
      <div class="checkbox-row">
        <input id="use_teacher_load" type="checkbox" checked>
        <label for="use_teacher_load" style="margin:0">Учитывать учебную нагрузку</label>
      </div>
      <div id="teacher_block">
        <div class="field">
          <label for="o_teacher_contract">Оклад за учебную нагрузку по договору, ₽</label>
          <input id="o_teacher_contract" type="number" min="0" step="0.01">
        </div>
        <div class="field">
          <label>Состав класса (количество обучающихся) <span class="info" tabindex="0" data-tooltip="Укажите численность по трем групповым уровням. Подсказка: для кейса «6-р» оставьте значения 4, 0 и 0.">?</span></label>
          <div class="sub-grid">
            <div class="field" style="margin-bottom:0">
              <label for="a1">A1</label>
              <input id="a1" type="number" min="0" step="1">
            </div>
            <div class="field" style="margin-bottom:0">
              <label for="a2">A2</label>
              <input id="a2" type="number" min="0" step="1">
            </div>
            <div class="field" style="margin-bottom:0">
              <label for="a3">A3</label>
              <input id="a3" type="number" min="0" step="1">
            </div>
          </div>
          <div id="teacher_warning" class="warning-text" aria-live="polite"></div>
        </div>
        <div class="field">
          <label>Строки учебной нагрузки (по предметам)</label>
          <div id="teacher_lines"></div>
          <button id="add_teacher_line" class="btn-secondary" type="button" style="margin-top:6px">Добавить предмет</button>
        </div>
        <div class="muted" style="font-size:13px">Расчёт по формуле 3.9: O_line = C_stu × t_week × Weeks_year / Months_year × (K_div + K_subj − 1)</div>
        <div class="stat-grid" aria-live="polite">
          <div class="stat-card">
            <div class="stat-label">По договору</div>
            <div class="stat-value" id="teacher_contract_display">0 ₽</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">По формуле 3.9</div>
            <div class="stat-value" id="teacher_formula_display">0 ₽</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Разница</div>
            <div class="stat-value" id="teacher_delta_display">0 ₽</div>
          </div>
        </div>
        <div class="stat-card teacher-overview" aria-live="polite">
          <div class="teacher-row">
            <span class="teacher-label">O_teacher_contract</span>
            <span class="teacher-badge" id="teacher_contract_chip">0 ₽</span>
          </div>
          <div class="teacher-row">
            <span class="teacher-label">O_teacher_calc</span>
            <span class="teacher-badge" id="teacher_calc_chip">0 ₽</span>
          </div>
          <div class="teacher-row">
            <span class="teacher-label">Delta_teacher</span>
            <span class="teacher-badge" id="teacher_delta_chip">0 ₽</span>
          </div>
        </div>
      </div>
    </section>

    <section>
      <h2>Разовые замены</h2>
      <div class="checkbox-row">
        <input id="use_substitution" type="checkbox" checked>
        <label for="use_substitution" style="margin:0">Учитывать замещающие уроки</label>
      </div>
      <div class="sub-grid" id="substitution_block">
        <div class="field">
          <label for="h_subst">Часы замещения в месяц</label>
          <input id="h_subst" type="number" min="0" step="1">
        </div>
        <div class="field">
          <label for="n_students">Количество учеников в классе/группе</label>
          <input id="n_students" type="number" min="1" max="25" step="1">
        </div>
        <div class="field">
          <label for="k_corr">K_corr: коэффициент за работу с детьми с умственной отсталостью <span class="info" tabindex="0" data-tooltip="Повышающий коэффициент за коррекционность. Обычно 1.2–1.4.">?</span></label>
          <input id="k_corr" type="number" min="0" step="0.05">
        </div>
        <div class="field">
          <label for="k_subst">K_subst: коэффициент за замещение отсутствующего учителя <span class="info" tabindex="0" data-tooltip="Оплата за фактическое замещение. Обычно 1.05–1.2.">?</span></label>
          <input id="k_subst" type="number" min="0" step="0.05">
        </div>
        <div class="field">
          <label for="k_usl_subst">Коэффициент условий труда (замещение) <span class="info" tabindex="0" data-tooltip="Особые условия при замещении. Обычно 1.0–1.2.">?</span></label>
          <input id="k_usl_subst" type="number" min="0" step="0.05">
        </div>
        <div class="field">
          <label for="u_value">Стоимость ученика-часа, ₽</label>
          <input id="u_value" type="number" min="0" step="1">
        </div>
      </div>
      <div class="checkbox-row" style="margin-top:4px">
        <input id="use_extra_subst" type="checkbox">
        <label for="use_extra_subst" style="margin:0">Учитывать дополнительное замещение</label>
      </div>
      <div class="sub-grid" id="extra_subst_block">
        <div class="field">
          <label for="h_sub_extra">Дополнительные часы (H_sub_extra)</label>
          <input id="h_sub_extra" type="number" min="0" step="1">
        </div>
        <div class="field">
          <label>Режим ставки (Subst_rate_mode)</label>
          <div class="flex-row" role="radiogroup" aria-labelledby="subst_rate_mode">
            <label><input type="radio" name="subst_rate_mode" value="order"> По приказу</label>
            <label><input type="radio" name="subst_rate_mode" value="student_hour"> По ученико-часу</label>
          </div>
        </div>
        <div class="field">
          <label for="r_sub_extra">Ставка по приказу (R_sub_extra), ₽</label>
          <input id="r_sub_extra" type="number" min="0" step="1">
        </div>
        <div class="field">
          <label for="n_class_subst">Численность класса для расчёта</label>
          <input id="n_class_subst" type="number" min="0" step="1">
        </div>
        <div class="field">
          <label for="class_type_subst">Тип класса (Class_type_subst)</label>
          <select id="class_type_subst">
            <option value="regular">Обычный</option>
            <option value="correctional">Коррекционный</option>
          </select>
        </div>
      </div>
    </section>

    <section>
      <h2>Компенсации</h2>
      <div class="checkbox-row">
        <input id="use_compensations" type="checkbox" checked>
        <label for="use_compensations" style="margin:0">Учитывать компенсационные выплаты</label>
      </div>
      <div class="field">
        <label>OVZ_base_mode: база для расчёта компенсации</label>
        <div class="flex-row" role="radiogroup" aria-label="OVZ_base_mode">
          <label><input type="radio" name="ovz_base_mode" value="logoped"> Логопедический</label>
          <label><input type="radio" name="ovz_base_mode" value="combined"> Логопедический + учительский</label>
        </div>
      </div>
      <div class="sub-grid">
        <div class="field" style="margin-bottom:0">
          <label for="k_ovz">% K_OVZ (0–20)</label>
          <input id="k_ovz" type="number" min="0" max="20" step="0.1">
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="comp_other">Прочие компенсации (Comp_other), ₽</label>
          <input id="comp_other" type="number" min="0" step="100">
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="comp_ovz">Компенсация за ОВЗ (Comp_OVZ), ₽</label>
          <input id="comp_ovz" type="number" readonly>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="comp_total">Итоговые компенсации (Comp_total), ₽</label>
          <input id="comp_total" type="number" readonly>
        </div>
      </div>
    </section>

    <section>
      <h2>Стимулирующие выплаты</h2>
      <div class="checkbox-row">
        <input id="use_stim" type="checkbox" checked>
        <label for="use_stim" style="margin:0">Учитывать стимулирующие выплаты</label>
      </div>
      <div id="stim_block">
        <div class="sub-grid">
          <div class="field" style="margin-bottom:0">
            <label for="stim_part1">Стимулирующая часть 1, ₽</label>
            <input id="stim_part1" type="number" min="0" step="100">
          </div>
          <div class="field" style="margin-bottom:0">
            <label for="stim_part2">Стимулирующая часть 2, ₽</label>
            <input id="stim_part2" type="number" min="0" step="100">
          </div>
          <div class="field" style="margin-bottom:0">
            <label for="stim_part3">Стимулирующая часть 3, ₽</label>
            <input id="stim_part3" type="number" min="0" step="100">
          </div>
        </div>
        <div class="field" style="margin-top:10px">
          <label for="stim_total">Stim_total, ₽</label>
          <input id="stim_total" type="number" readonly>
        </div>
      </div>
    </section>

    <section>
      <h2>Налоги и удержания</h2>
      <div class="sub-grid">
        <div class="field" style="margin-bottom:0">
          <label for="ndfl_rate">Ставка НДФЛ, %</label>
          <input id="ndfl_rate" type="number" min="0" max="100" step="0.1">
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="other_withholdings">Прочие удержания, ₽</label>
          <input id="other_withholdings" type="number" min="0" step="100">
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="ndfl_amount">Ndfl_amount, ₽</label>
          <input id="ndfl_amount" type="number" readonly>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="total_withhold">Total_withhold, ₽</label>
          <input id="total_withhold" type="number" readonly>
        </div>
      </div>
    </section>

    <section>
      <h2>Помощь и нормативные документы</h2>
      <details>
        <summary>Открыть справку</summary>
        <div class="accordion-content">
          <p>Ключевые подсказки для корректного ввода данных:</p>
          <ul>
            <li>Проверьте актуальность стоимости ученико-часа и коэффициентов по последнему приказу учреждения.</li>
            <li>Для замещений уточняйте коэффициенты K_corr и K_subst в локальных актах (обычно 1.05–1.2).</li>
            <li>Ставку НДФЛ и удержания вводите в соответствии с персональными условиями сотрудника.</li>
          </ul>
          <p class="muted">Приказ об оплате труда, Положение о стимулирующих и локальные нормативные акты школы помогут быстро заполнить форму.</p>
        </div>
      </details>
    </section>

    <section>
      <h2>Итоги и расшифровка</h2>
      <details open>
        <summary>Краткие итоги</summary>
        <div class="accordion-content" id="totals_breakdown"></div>
      </details>
      <details>
        <summary>Оклад логопеда</summary>
        <div class="accordion-content" id="logoped_breakdown"></div>
      </details>
      <details>
        <summary>Учебная нагрузка</summary>
        <div class="accordion-content" id="teacher_breakdown"></div>
      </details>
      <details>
        <summary>Разовые замены</summary>
        <div class="accordion-content" id="substitution_breakdown"></div>
      </details>
      <details>
        <summary>Компенсации</summary>
        <div class="accordion-content" id="comp_breakdown"></div>
      </details>
      <details>
        <summary>Стимулирующие выплаты</summary>
        <div class="accordion-content" id="stim_breakdown"></div>
      </details>
      <details>
        <summary>Налоги и удержания</summary>
        <div class="accordion-content" id="taxes_breakdown"></div>
      </details>
      <div class="buttons">
        <button class="btn-secondary" id="reset_btn" type="button">Сбросить к значениям по умолчанию</button>
        <button class="btn-primary" id="copy_btn" type="button">Скопировать результат</button>
      </div>
    </section>
  </div>

  <script>
    const defaults = {
      period: '2025/2026',
      organization: 'ГБОУ Школа № 1400',
      worker_category: 'Иные педагогические работники (логопед/дефектолог)',
      c_stu: 37,
      weeks_year: 34,
      months_year: 12,
      t_logoped: 70000,
      logoped_share: 1.0,
      use_teacher_load: true,
      a1: 4,
      a2: 0,
      a3: 0,
      o_teacher_contract: 31869.33,
      use_substitution: true,
      h_subst: 12,
      n_students: 8,
      k_corr: 1.3,
      k_subst: 1.1,
      k_usl_subst: 1.0,
      u_value: 37,
      use_extra_subst: false,
      h_sub_extra: 0,
      subst_rate_mode: 'order',
      r_sub_extra: 700,
      n_class_subst: 0,
      class_type_subst: 'regular',
      use_compensations: true,
      ovz_base_mode: 'logoped',
      k_ovz: 20,
      comp_other: 0,
      use_stim: true,
      stim_part1: 3000,
      stim_part2: 0,
      stim_part3: 0,
      ndfl_rate: 13,
      other_withholdings: 0,
    };

    const inputs = {
      period: document.getElementById('period'),
      organization: document.getElementById('organization'),
      worker_category: document.getElementById('worker_category'),
      c_stu: document.getElementById('c_stu'),
      weeks_year: document.getElementById('weeks_year'),
      months_year: document.getElementById('months_year'),
      t_logoped: document.getElementById('t_logoped'),
      logoped_share: document.getElementById('logoped_share'),
      use_teacher_load: document.getElementById('use_teacher_load'),
      a1: document.getElementById('a1'),
      a2: document.getElementById('a2'),
      a3: document.getElementById('a3'),
      o_teacher_contract: document.getElementById('o_teacher_contract'),
      use_substitution: document.getElementById('use_substitution'),
      h_subst: document.getElementById('h_subst'),
      n_students: document.getElementById('n_students'),
      k_corr: document.getElementById('k_corr'),
      k_subst: document.getElementById('k_subst'),
      k_usl_subst: document.getElementById('k_usl_subst'),
      u_value: document.getElementById('u_value'),
      use_extra_subst: document.getElementById('use_extra_subst'),
      h_sub_extra: document.getElementById('h_sub_extra'),
      r_sub_extra: document.getElementById('r_sub_extra'),
      n_class_subst: document.getElementById('n_class_subst'),
      class_type_subst: document.getElementById('class_type_subst'),
      use_compensations: document.getElementById('use_compensations'),
      k_ovz: document.getElementById('k_ovz'),
      comp_other: document.getElementById('comp_other'),
      use_stim: document.getElementById('use_stim'),
      stim_part1: document.getElementById('stim_part1'),
      stim_part2: document.getElementById('stim_part2'),
      stim_part3: document.getElementById('stim_part3'),
      ndfl_rate: document.getElementById('ndfl_rate'),
      other_withholdings: document.getElementById('other_withholdings'),
    };

    const summaryDisplay = document.getElementById('total_display');
    const summaryBreakdown = document.getElementById('summary_breakdown');
    const totalsBreakdown = document.getElementById('totals_breakdown');
    const logopedBreakdown = document.getElementById('logoped_breakdown');
    const teacherBreakdown = document.getElementById('teacher_breakdown');
    const teacherContractDisplay = document.getElementById('teacher_contract_display');
    const teacherFormulaDisplay = document.getElementById('teacher_formula_display');
    const teacherDeltaDisplay = document.getElementById('teacher_delta_display');
    const teacherContractChip = document.getElementById('teacher_contract_chip');
    const teacherCalcChip = document.getElementById('teacher_calc_chip');
    const teacherDeltaChip = document.getElementById('teacher_delta_chip');
    const substitutionBreakdown = document.getElementById('substitution_breakdown');
    const compBreakdown = document.getElementById('comp_breakdown');
    const stimBreakdown = document.getElementById('stim_breakdown');
    const taxesBreakdown = document.getElementById('taxes_breakdown');
    const teacherBlock = document.getElementById('teacher_block');
    const teacherLinesContainer = document.getElementById('teacher_lines');
    const addTeacherLineBtn = document.getElementById('add_teacher_line');
    const substitutionBlock = document.getElementById('substitution_block');
    const extraSubstBlock = document.getElementById('extra_subst_block');
    const resetBtn = document.getElementById('reset_btn');
    const copyBtn = document.getElementById('copy_btn');
    const mrotWarning = document.getElementById('mrot_warning');
    const teacherWarning = document.getElementById('teacher_warning');
    const stimBlock = document.getElementById('stim_block');
    const stimTotalField = document.getElementById('stim_total');
    const ndflAmountField = document.getElementById('ndfl_amount');
    const totalWithholdField = document.getElementById('total_withhold');
    const MROT = 19372;
    const CORRECTION_CLASS_COEF = 1.3;
    const DELTA_CLASSES = ['delta-positive', 'delta-negative'];

    const substRateRadios = document.querySelectorAll('input[name="subst_rate_mode"]');
    const ovzBaseRadios = document.querySelectorAll('input[name="ovz_base_mode"]');
    const compOvzField = document.getElementById('comp_ovz');
    const compTotalField = document.getElementById('comp_total');

    const defaultTeacherLines = [
      { id: crypto.randomUUID(), subject: 'Русский язык (6-р)', t_week: 12, k_div: 6.25, k_subj: 1.1 },
    ];
    let teacherLines = [];

    function formatMoney(value) {
      return `${value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ₽`;
    }

    function formatSignedMoney(value) {
      const sign = value > 0 ? '+' : value < 0 ? '−' : '';
      const absolute = Math.abs(value);
      return `${sign}${formatMoney(absolute)}`;
    }

    function formatPercent(value) {
      return `${value.toFixed(1)} %`;
    }

    function parseNumber(input) {
      const value = parseFloat(input.value);
      const valid = Number.isFinite(value) && value >= 0;
      input.classList.toggle('invalid', !valid);
      return valid ? value : 0;
    }

    function setDefaults() {
      Object.entries(defaults).forEach(([key, value]) => {
        const field = inputs[key];
        if (!field) return;
        if (field.type === 'checkbox') {
          field.checked = Boolean(value);
        } else {
          field.value = value;
        }
      });
      substRateRadios.forEach((radio) => {
        radio.checked = radio.value === defaults.subst_rate_mode;
      });
      ovzBaseRadios.forEach((radio) => {
        radio.checked = radio.value === defaults.ovz_base_mode;
      });
      resetTeacherLines();
      handleToggles();
      recalc();
    }

    function resetTeacherLines() {
      teacherLines = defaultTeacherLines.map((line) => ({ ...line, id: crypto.randomUUID() }));
      renderTeacherLines();
    }

    function renderTeacherLines() {
      teacherLinesContainer.innerHTML = '';
      teacherLines.forEach((line) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'sub-grid teacher-line';
        wrapper.dataset.lineId = line.id;

        const subjectField = document.createElement('div');
        subjectField.className = 'field';
        const subjectLabel = document.createElement('label');
        subjectLabel.textContent = 'Предмет';
        const subjectInput = document.createElement('input');
        subjectInput.type = 'text';
        subjectInput.value = line.subject;
        subjectInput.addEventListener('input', (e) => {
          line.subject = e.target.value;
        });
        subjectField.append(subjectLabel, subjectInput);

        const hoursField = document.createElement('div');
        hoursField.className = 'field';
        const hoursLabel = document.createElement('label');
        hoursLabel.textContent = 'Часов в неделю (t_week)';
        const hoursInput = document.createElement('input');
        hoursInput.type = 'number';
        hoursInput.min = '0';
        hoursInput.step = '0.5';
        hoursInput.value = line.t_week;
        hoursInput.addEventListener('input', (e) => {
          line.t_week = Number(e.target.value);
          recalc();
        });
        hoursField.append(hoursLabel, hoursInput);

        const kDivField = document.createElement('div');
        kDivField.className = 'field';
        const kDivLabel = document.createElement('label');
        kDivLabel.textContent = 'K_div';
        const kDivInput = document.createElement('input');
        kDivInput.type = 'number';
        kDivInput.min = '1';
        kDivInput.step = '0.05';
        kDivInput.value = line.k_div;
        kDivInput.addEventListener('input', (e) => {
          line.k_div = Number(e.target.value);
          recalc();
        });
        kDivField.append(kDivLabel, kDivInput);

        const kSubjField = document.createElement('div');
        kSubjField.className = 'field';
        const kSubjLabel = document.createElement('label');
        kSubjLabel.textContent = 'K_subj';
        const kSubjInput = document.createElement('input');
        kSubjInput.type = 'number';
        kSubjInput.min = '1';
        kSubjInput.step = '0.05';
        kSubjInput.value = line.k_subj;
        kSubjInput.addEventListener('input', (e) => {
          line.k_subj = Number(e.target.value);
          recalc();
        });
        kSubjField.append(kSubjLabel, kSubjInput);

        const removeField = document.createElement('div');
        removeField.className = 'field';
        const removeLabel = document.createElement('label');
        removeLabel.textContent = 'Удалить строку';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-secondary';
        removeBtn.textContent = 'Удалить';
        removeBtn.addEventListener('click', () => {
          teacherLines = teacherLines.filter((item) => item.id !== line.id);
          renderTeacherLines();
          recalc();
        });
        removeField.append(removeLabel, removeBtn);

        wrapper.append(subjectField, hoursField, kDivField, kSubjField, removeField);
        teacherLinesContainer.appendChild(wrapper);
      });
      handleToggles();
    }

    function handleToggles() {
      const teacherEnabled = inputs.use_teacher_load.checked;
      teacherBlock.classList.toggle('hidden', !teacherEnabled);
      [...teacherBlock.querySelectorAll('input, button')].forEach((el) => {
        if (el.id !== 'use_teacher_load') {
          el.disabled = !teacherEnabled;
        }
      });
      addTeacherLineBtn.disabled = !teacherEnabled;

      const substitutionEnabled = inputs.use_substitution.checked;
      const extraSubstitutionEnabled = inputs.use_extra_subst.checked;
      const shouldEnableUValue = substitutionEnabled || extraSubstitutionEnabled;
      [...substitutionBlock.querySelectorAll('input')].forEach((el) => {
        if (el.id === 'u_value') {
          el.disabled = !shouldEnableUValue;
          return;
        }
        if (el.id !== 'use_substitution') {
          el.disabled = !substitutionEnabled;
        }
      });

      [...extraSubstBlock.querySelectorAll('input, select')].forEach((el) => {
        if (el.id !== 'use_extra_subst') {
          el.disabled = !extraSubstitutionEnabled;
        }
      });

      const compensationEnabled = inputs.use_compensations.checked;
      inputs.k_ovz.disabled = !compensationEnabled;
      inputs.comp_other.disabled = !compensationEnabled;
      compOvzField.disabled = !compensationEnabled;
      compTotalField.disabled = !compensationEnabled;
      ovzBaseRadios.forEach((radio) => {
        radio.disabled = !compensationEnabled;
      });

      const stimEnabled = inputs.use_stim.checked;
      stimBlock.classList.toggle('hidden', !stimEnabled);
      [...stimBlock.querySelectorAll('input')].forEach((el) => {
        el.disabled = !stimEnabled;
      });
    }

    function recalc() {
      const tLogoped = parseNumber(inputs.t_logoped);
      const share = parseNumber(inputs.logoped_share);

      const baseOklad = tLogoped * share;
      const zLogoped = baseOklad;

      const cStu = parseNumber(inputs.c_stu);
      const weeksYear = parseNumber(inputs.weeks_year);
      const monthsYear = parseNumber(inputs.months_year);

      const useTeacher = inputs.use_teacher_load.checked;
      const oTeacherContract = useTeacher ? parseNumber(inputs.o_teacher_contract) : 0;
      const a1 = useTeacher ? parseNumber(inputs.a1) : 0;
      const a2 = useTeacher ? parseNumber(inputs.a2) : 0;
      const a3 = useTeacher ? parseNumber(inputs.a3) : 0;
      const studentSum = a1 + a2 + a3;
      const hasTeacherLoad = useTeacher && (oTeacherContract > 0 || teacherLines.some((line) => (Number(line.t_week) || 0) > 0));

      const teacherCalc = useTeacher ? calculateTeacherLoad(cStu, weeksYear, monthsYear) : { total: 0, lines: [] };

      const useSubst = inputs.use_substitution.checked;
      const hSubst = useSubst ? parseNumber(inputs.h_subst) : 0;
      const nStudents = useSubst ? parseNumber(inputs.n_students) : 0;
      const kCorr = useSubst ? parseNumber(inputs.k_corr) : 0;
      const kSubst = useSubst ? parseNumber(inputs.k_subst) : 0;
      const kUslSubst = useSubst ? parseNumber(inputs.k_usl_subst) : 0;
      const useExtraSubst = inputs.use_extra_subst.checked;
      const uValue = (useSubst || useExtraSubst) ? parseNumber(inputs.u_value) : 0;

      const cHour = useSubst ? uValue * nStudents * kCorr * kSubst * kUslSubst : 0;
      const zSubst = hSubst * cHour;

      const substRateMode = Array.from(substRateRadios).find((radio) => radio.checked)?.value || defaults.subst_rate_mode;
      const hSubExtra = useExtraSubst ? parseNumber(inputs.h_sub_extra) : 0;
      const rSubExtra = useExtraSubst ? parseNumber(inputs.r_sub_extra) : 0;
      const nClassSubst = useExtraSubst ? parseNumber(inputs.n_class_subst) : 0;
      const classTypeSubst = inputs.class_type_subst.value;
      const classTypeCoef = classTypeSubst === 'correctional' ? CORRECTION_CLASS_COEF : 1;
      const rSubCurrent = useExtraSubst && hSubExtra > 0
        ? (substRateMode === 'order' ? rSubExtra : uValue * nClassSubst * classTypeCoef)
        : 0;
      const zSubstExtra = useExtraSubst && hSubExtra > 0 ? hSubExtra * rSubCurrent : 0;

      const useComp = inputs.use_compensations.checked;
      const ovzBaseMode = Array.from(ovzBaseRadios).find((radio) => radio.checked)?.value || defaults.ovz_base_mode;
      const kOvz = useComp ? parseNumber(inputs.k_ovz) : 0;
      const compOther = useComp ? parseNumber(inputs.comp_other) : 0;
      const ovzBase = ovzBaseMode === 'combined' ? baseOklad + oTeacherContract : baseOklad;
      const compOvz = useComp ? ovzBase * (kOvz / 100) : 0;
      const compTotal = useComp ? compOvz + compOther : 0;
      const zComp = compTotal;

      const useStim = inputs.use_stim.checked;
      const stimPart1 = useStim ? parseNumber(inputs.stim_part1) : 0;
      const stimPart2 = useStim ? parseNumber(inputs.stim_part2) : 0;
      const stimPart3 = useStim ? parseNumber(inputs.stim_part3) : 0;
      const zStim = useStim ? stimPart1 + stimPart2 + stimPart3 : 0;
      stimTotalField.value = zStim.toFixed(2);

      const grossTotal = zLogoped + oTeacherContract + zSubst + zSubstExtra + zComp + zStim;
      const grossSalary = grossTotal;

      const ndflRateRaw = parseNumber(inputs.ndfl_rate);
      const ndflRate = Math.min(100, ndflRateRaw);
      if (ndflRate !== ndflRateRaw) {
        inputs.ndfl_rate.value = ndflRate.toFixed(1).replace(/\.0$/, '');
      }
      const otherWithholdings = parseNumber(inputs.other_withholdings);
      const ndflAmount = grossTotal * (ndflRate / 100);
      const totalWithhold = ndflAmount + otherWithholdings;
      const netTotal = grossTotal - totalWithhold;
      const netSalary = grossSalary > 0 ? netTotal : 0;

      const shareSubstPercent = grossSalary > 0 ? (zSubstExtra / grossSalary) * 100 : null;
      const substHourNet = hSubExtra > 0
        ? (zSubstExtra * (1 - ndflRate / 100)) / hSubExtra
        : null;

      const teacherDelta = teacherCalc.total - oTeacherContract;

      summaryDisplay.textContent = `На руки (Net_salary): ${formatMoney(netSalary)} • Брутто (Gross_salary): ${formatMoney(grossSalary)}`;
      const summaryText = `
        <strong>Оклад логопеда:</strong> ${formatMoney(zLogoped)}<br>
        <strong>Учебная нагрузка:</strong> договор — ${formatMoney(oTeacherContract)}, формула — ${formatMoney(teacherCalc.total)}, Δ — ${formatSignedMoney(teacherDelta)}<br>
        <strong>Разовые замены:</strong> базовые — ${formatMoney(zSubst)}, доп. — ${formatMoney(zSubstExtra)}<br>
        <strong>Компенсации:</strong> ${formatMoney(compTotal)} (ОВЗ — ${formatMoney(compOvz)}, прочие — ${formatMoney(compOther)})<br>
        <strong>Стимулирующие:</strong> ${formatMoney(zStim)}<br>
        <strong>Налоги и удержания:</strong> НДФЛ ${ndflRate.toFixed(1).replace(/\.0$/, '')}% — ${formatMoney(ndflAmount)}, прочие — ${formatMoney(otherWithholdings)}, всего — ${formatMoney(totalWithhold)}<br>
        <strong>Итоги:</strong> Gross_salary — ${formatMoney(grossSalary)}, Net_salary — ${formatMoney(netSalary)}<br>
        Доля разовых замен в Gross_salary: <strong>${shareSubstPercent === null ? '—' : formatPercent(shareSubstPercent)}</strong><br>
        Цена 1 часа доп. замены «на руки»: <strong>${substHourNet === null ? '—' : formatMoney(substHourNet)}</strong>
      `;
      summaryBreakdown.innerHTML = summaryText;
      totalsBreakdown.innerHTML = summaryText;

      logopedBreakdown.innerHTML = `
        Формула: Base_logoped = O_logoped_base × S_log<br>
        = ${formatMoney(tLogoped)} × ${share.toFixed(2)}<br>
        = <strong>${formatMoney(zLogoped)}</strong>
      `;

      teacherBreakdown.innerHTML = useTeacher ? `
        По договору: <strong>${formatMoney(oTeacherContract)}</strong><br>
        По формуле: <strong>${formatMoney(teacherCalc.total)}</strong><br>
        Разница: <strong>${formatMoney(teacherDelta)}</strong><br><br>
        ${teacherCalc.lines.join('<br>') || 'Строки нагрузки не указаны.'}
      ` : 'Учебная нагрузка не учитывается.';

      teacherContractDisplay.textContent = formatMoney(oTeacherContract);
      teacherFormulaDisplay.textContent = formatMoney(teacherCalc.total);
      teacherDeltaDisplay.textContent = formatMoney(teacherDelta);
      teacherContractChip.textContent = formatMoney(oTeacherContract);
      teacherCalcChip.textContent = formatMoney(teacherCalc.total);
      teacherDeltaChip.textContent = formatSignedMoney(teacherDelta);
      teacherDeltaChip.classList.remove(...DELTA_CLASSES);
      if (teacherDelta > 0) {
        teacherDeltaChip.classList.add('delta-positive');
      } else if (teacherDelta < 0) {
        teacherDeltaChip.classList.add('delta-negative');
      }

      const baseSubstitutionText = useSubst ? `
        Стоимость часа: C_ч = U × N_учеников × K_corr × K_subst × K_усл_subst<br>
        = ${formatMoney(uValue)} × ${nStudents.toFixed(0)} × ${kCorr.toFixed(2)} × ${kSubst.toFixed(2)} × ${kUslSubst.toFixed(2)}<br>
        = <strong>${formatMoney(cHour)}</strong><br><br>
        Итог за месяц: Z_subst = H_subst × C_ч = ${hSubst.toFixed(0)} × ${formatMoney(cHour)}<br>
        = <strong>${formatMoney(zSubst)}</strong>
      ` : 'Базовое замещение не учитывается.';

      const extraRateText = substRateMode === 'order'
        ? `Режим «по приказу»: R_sub_current = ${formatMoney(rSubCurrent)}`
        : `Режим «по ученико-часу»: R_sub_current = U × N_class_subst × K_class = ${formatMoney(uValue)} × ${nClassSubst.toFixed(0)} × ${classTypeCoef.toFixed(2)} = <strong>${formatMoney(rSubCurrent)}</strong>`;

      const extraSubstitutionText = useExtraSubst ? `
        ${extraRateText}<br><br>
        Subst_extra = H_sub_extra × R_sub_current = ${hSubExtra.toFixed(0)} × ${formatMoney(rSubCurrent)}<br>
        = <strong>${formatMoney(zSubstExtra)}</strong>
      ` : 'Дополнительное замещение не учитывается.';

      const substitutionStatsText = `
        Share_subst_percent = ${shareSubstPercent === null ? '—' : `<strong>${formatPercent(shareSubstPercent)}</strong>`}<br>
        Subst_hour_net = ${substHourNet === null ? '—' : `<strong>${formatMoney(substHourNet)}</strong>`}
      `;

      substitutionBreakdown.innerHTML = `${baseSubstitutionText}<br><br>${extraSubstitutionText}<br><br>${substitutionStatsText}`;

      const compText = useComp ? `
        OVZ_base_mode: ${ovzBaseMode === 'combined' ? 'логопедический + учительский' : 'логопедический'}<br>
        Comp_OVZ = Base × K_OVZ = ${formatMoney(ovzBase)} × ${kOvz.toFixed(2)}% = <strong>${formatMoney(compOvz)}</strong><br>
        Comp_other = <strong>${formatMoney(compOther)}</strong><br>
        Comp_total = <strong>${formatMoney(compTotal)}</strong>
      ` : 'Компенсации не учитываются.';

      const stimText = useStim ? `
        Стимулирующие части: ${formatMoney(stimPart1)}, ${formatMoney(stimPart2)}, ${formatMoney(stimPart3)}<br>
        Stim_total = <strong>${formatMoney(zStim)}</strong>
      ` : 'Стимулирующие не учитываются.';

      const taxesText = `
        Gross_salary = <strong>${formatMoney(grossSalary)}</strong><br>
        НДФЛ (${ndflRate.toFixed(1).replace(/\.0$/, '')}%): <strong>${formatMoney(ndflAmount)}</strong><br>
        Прочие удержания: <strong>${formatMoney(otherWithholdings)}</strong><br>
        Total_withhold = <strong>${formatMoney(totalWithhold)}</strong><br>
        Net_salary = <strong>${formatMoney(netSalary)}</strong>
      `;

      compBreakdown.innerHTML = compText;
      stimBreakdown.innerHTML = stimText;
      taxesBreakdown.innerHTML = taxesText;

      compOvzField.value = compOvz.toFixed(2);
      compTotalField.value = compTotal.toFixed(2);
      ndflAmountField.value = ndflAmount.toFixed(2);
      totalWithholdField.value = totalWithhold.toFixed(2);

      if (baseOklad < MROT && baseOklad > 0) {
        mrotWarning.textContent = `Внимание: расчетный оклад ниже МРОТ (${formatMoney(MROT)}). Проверьте доплаты.`;
      } else {
        mrotWarning.textContent = '';
      }

      if (hasTeacherLoad && studentSum === 0) {
        teacherWarning.textContent = 'Предупреждение: a1 + a2 + a3 = 0 при заданной учебной нагрузке. Уточните численность обучающихся.';
      } else {
        teacherWarning.textContent = '';
      }
    }

    function calculateTeacherLoad(cStu, weeksYear, monthsYear) {
      let total = 0;
      const lines = [];

      teacherLines.forEach((line, index) => {
        const tWeek = Math.max(0, Number(line.t_week) || 0);
        const kDiv = Math.max(1, Number(line.k_div) || 0);
        const kSubj = Math.max(1, Number(line.k_subj) || 0);
        const kTotal = Math.max(0, kDiv + kSubj - 1);
        const oLine = cStu * tWeek * weeksYear / monthsYear * kTotal;
        total += oLine;
        lines.push(`Строка ${index + 1} (${line.subject || 'без названия'}): ${formatMoney(oLine)} (t_week=${tWeek.toFixed(2)}, K_div=${kDiv.toFixed(2)}, K_subj=${kSubj.toFixed(2)}, K_total=${kTotal.toFixed(2)})`);
      });

      return { total, lines };
    }

    function attachListeners() {
      Object.values(inputs).forEach((el) => {
        el.addEventListener('input', () => {
          handleToggles();
          recalc();
        });
        el.addEventListener('change', () => {
          handleToggles();
          recalc();
        });
      });

      substRateRadios.forEach((radio) => {
        radio.addEventListener('change', () => {
          handleToggles();
          recalc();
        });
      });

      ovzBaseRadios.forEach((radio) => {
        radio.addEventListener('change', () => {
          handleToggles();
          recalc();
        });
      });

      resetBtn.addEventListener('click', setDefaults);

      addTeacherLineBtn.addEventListener('click', () => {
        teacherLines.push({ id: crypto.randomUUID(), subject: '', t_week: 0, k_div: 1, k_subj: 1 });
        renderTeacherLines();
        recalc();
      });

      copyBtn.addEventListener('click', async () => {
        const text = `Итоговая сумма: ${summaryDisplay.textContent.replace('Итоговая сумма за месяц: ', '')}\n` +
          summaryBreakdown.innerText.replace(/\s+/g, ' ').trim();
        try {
          await navigator.clipboard.writeText(text);
          copyBtn.textContent = 'Скопировано!';
          setTimeout(() => copyBtn.textContent = 'Скопировать результат', 1500);
        } catch (e) {
          copyBtn.textContent = 'Не удалось скопировать';
          setTimeout(() => copyBtn.textContent = 'Скопировать результат', 1500);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setDefaults();
      attachListeners();
    });
  </script>
</body>
</html>
