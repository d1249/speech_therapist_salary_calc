<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Калькулятор оплаты логопеда</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #1c252e;
      --accent: #216869;
      --accent-soft: #c8ece8;
      --border: #cbd5e1;
      --danger: #d93025;
      --focus: #134e4a;
    }

    * { box-sizing: border-box; }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 620px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .summary {
      background: linear-gradient(135deg, var(--accent), #3aafa9);
      color: #fff;
      border: none;
      position: sticky;
      top: -10px;
      inset-inline: 0;
      z-index: 20;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .summary-headline {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
    }

    .summary-title {
      font-size: 16px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-weight: 700;
      opacity: 0.9;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }

    .summary-chip {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 72px;
    }

    .summary-chip.primary {
      background: rgba(255, 255, 255, 0.18);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .summary-chip .label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      opacity: 0.85;
      font-weight: 700;
    }

    .summary-chip .value {
      font-size: 22px;
      font-weight: 800;
      line-height: 1.2;
    }

    .summary-details {
      font-size: 14px;
      line-height: 1.6;
      opacity: 0.9;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .input-with-unit {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .unit-badge {
      background: var(--accent-soft);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      font-weight: 700;
      font-size: 12px;
      color: var(--text);
      white-space: nowrap;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 15px;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    input[readonly], input:disabled, select:disabled {
      background: #f0f4f8;
      color: #738391;
      cursor: not-allowed;
    }

    input.invalid {
      border-color: var(--danger);
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .sub-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 12px;
    }

    details {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #f8fbff;
      padding: 10px 12px;
      margin-top: 8px;
    }

    details summary {
      cursor: pointer;
      font-weight: 700;
      list-style: none;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    .hidden {
      display: none;
    }

    .accordion-content {
      margin-top: 8px;
      line-height: 1.5;
      font-size: 14px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #f8fbff;
    }

    .teacher-overview {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .teacher-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .teacher-label {
      font-size: 13px;
      color: #52606d;
      font-weight: 600;
    }

    .teacher-badge {
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 700;
      background: var(--accent-soft);
      border: 1px solid var(--border);
      min-width: 120px;
      text-align: right;
    }

    .delta-positive {
      color: #0f9151;
      background: #e5f5ee;
      border-color: #c5eadc;
    }

    .delta-negative {
      color: var(--danger);
      background: #fde8e8;
      border-color: #facdcd;
    }

    .stat-label {
      font-size: 13px;
      color: #52606d;
      margin-bottom: 6px;
    }

    .stat-value {
      font-weight: 700;
      font-size: 18px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-secondary {
      background: var(--accent-soft);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .info {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 12px;
      font-weight: 700;
      position: relative;
      cursor: help;
      border: 1px solid var(--accent);
    }

    .info::after {
      content: attr(data-tooltip);
      position: absolute;
      top: 26px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      opacity: 0;
      visibility: hidden;
      width: max-content;
      max-width: 260px;
      font-weight: 500;
      z-index: 2;
      font-size: 12px;
    }

    .info:focus::after,
    .info:hover::after {
      opacity: 1;
      visibility: visible;
    }

    input:focus-visible,
    select:focus-visible,
    button:focus-visible,
    summary:focus-visible,
    .info:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 3px;
      box-shadow: 0 0 0 3px rgba(19, 78, 74, 0.15);
    }

    details:focus-within {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(19, 78, 74, 0.08);
    }

    .muted {
      color: #52606d;
      font-size: 14px;
    }

    .warning-text {
      color: var(--danger);
      font-size: 14px;
      margin-top: -6px;
    }

    .input-message {
      color: var(--danger);
      font-size: 13px;
      margin-top: -4px;
    }

    .flex-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    @media (max-width: 420px) {
      body {
        padding: 12px;
      }

      h1 {
        font-size: 22px;
      }

      h2 {
        font-size: 16px;
      }

      section {
        padding: 14px;
      }

      .summary {
        margin-left: -4px;
        margin-right: -4px;
        border-radius: 0 0 12px 12px;
      }

      .summary-chip .value {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Калькулятор оплаты логопеда</h1>
      <p class="muted">Расчёт месячной оплаты с учётом оклада, замещения, компенсаций и стимулирующих. Все суммы и часы вводятся сразу за месяц.</p>
    </header>

    <section class="summary" aria-live="polite">
      <div class="summary-headline">
        <div class="summary-title">Итоги за месяц</div>
        <div class="summary-grid">
          <div class="summary-chip primary">
            <div class="label">На руки</div>
            <div class="value" id="net_display">0 ₽</div>
          </div>
          <div class="summary-chip">
            <div class="label">Брутто</div>
            <div class="value" id="gross_display">0 ₽</div>
          </div>
        </div>
      </div>
      <div class="summary-details" id="summary_breakdown"></div>
    </section>

    <section>
      <h2>Общие настройки</h2>
      <div class="field">
        <label for="system">Система расчёта</label>
        <input id="system" type="text" value="Москва (ученик-час = 37 ₽)" readonly>
      </div>
      <div class="field">
        <label for="period">Период расчёта</label>
        <input id="period" type="text" value="2025/2026" readonly>
      </div>
      <div class="field">
        <label for="organization">Организация</label>
        <input id="organization" type="text" value="ГБОУ Школа № 1400" readonly>
      </div>
      <div class="field">
        <label for="worker_category">Категория работника</label>
        <input id="worker_category" type="text" value="Иные педагогические работники (логопед/дефектолог)" readonly>
      </div>
      <div class="field">
        <label for="c_stu">Стоимость 1 ученико-часа (C_stu) <span class="info" tabindex="0" data-tooltip="Нормативная стоимость одного ученико-часа по приказу/Положению об оплате труда.">?</span></label>
        <div class="input-with-unit">
          <input id="c_stu" type="number" min="0" step="1">
          <span class="unit-badge">₽/ученико-час</span>
        </div>
      </div>
      <div class="field">
        <label for="weeks_year">Количество учебных недель (Weeks_year)</label>
        <div class="input-with-unit">
          <input id="weeks_year" type="number" min="1" max="52" step="1">
          <span class="unit-badge">нед.</span>
        </div>
      </div>
      <div class="field">
        <label for="months_year">Количество месяцев в году (Months_year)</label>
        <div class="input-with-unit">
          <input id="months_year" type="number" value="12" readonly>
          <span class="unit-badge">мес.</span>
        </div>
      </div>
    </section>

    <section>
      <h2>Оклад логопеда</h2>
      <div class="field">
        <label for="t_logoped">Оклад логопеда за 1 ставку (O_logoped_base) <span class="info" tabindex="0" data-tooltip="Должностной оклад за полную ставку по трудовому договору или тарификационному списку, до удержаний НДФЛ.">?</span></label>
        <div class="input-with-unit">
          <input id="t_logoped" type="number" min="0" step="100">
          <span class="unit-badge">₽/мес</span>
        </div>
      </div>
      <div class="field">
        <label for="logoped_share">Доля ставки логопеда</label>
        <div class="input-with-unit">
          <input id="logoped_share" type="number" min="0" max="1" step="0.25">
          <span class="unit-badge">ставки</span>
        </div>
      </div>
      <div id="mrot_warning" class="warning-text" aria-live="polite"></div>
    </section>

    <section>
      <h2>Учебная нагрузка как учитель <span class="info" tabindex="0" data-tooltip="Укажите оплачиваемую нагрузку по предметам: количество обучающихся, часы в неделю и коэффициенты для расчёта формулы 3.9.">?</span></h2>
      <div class="checkbox-row">
        <input id="use_teacher_load" type="checkbox" checked>
        <label for="use_teacher_load" style="margin:0">Учитывать учебную нагрузку</label>
      </div>
      <div id="teacher_block">
        <div class="field">
          <label for="o_teacher_contract">Оклад за учебную нагрузку по договору, ₽</label>
          <div class="input-with-unit">
            <input id="o_teacher_contract" type="number" min="0" step="0.01">
            <span class="unit-badge">₽/мес</span>
          </div>
        </div>
        <div class="field">
          <label>Состав класса (количество обучающихся) <span class="info" tabindex="0" data-tooltip="Укажите численность по трем групповым уровням. Подсказка: для кейса «6-р» оставьте значения 4, 0 и 0.">?</span></label>
          <div class="sub-grid">
            <div class="field" style="margin-bottom:0">
              <label for="a1">A1</label>
              <div class="input-with-unit">
                <input id="a1" type="number" min="0" step="1">
                <span class="unit-badge">учеников</span>
              </div>
            </div>
            <div class="field" style="margin-bottom:0">
              <label for="a2">A2</label>
              <div class="input-with-unit">
                <input id="a2" type="number" min="0" step="1">
                <span class="unit-badge">учеников</span>
              </div>
            </div>
            <div class="field" style="margin-bottom:0">
              <label for="a3">A3</label>
              <div class="input-with-unit">
                <input id="a3" type="number" min="0" step="1">
                <span class="unit-badge">учеников</span>
              </div>
            </div>
          </div>
          <div id="teacher_warning" class="warning-text" aria-live="polite"></div>
        </div>
        <div class="field">
          <label>Строки учебной нагрузки (по предметам)</label>
          <div id="teacher_lines"></div>
          <button id="add_teacher_line" class="btn-secondary" type="button" style="margin-top:6px">Добавить предмет</button>
        </div>
        <div class="muted" style="font-size:13px">Расчёт по формуле 3.9: O_line = C_stu × t_week × Weeks_year / Months_year × (K_div + K_subj − 1)</div>
        <div class="stat-grid" aria-live="polite">
          <div class="stat-card">
            <div class="stat-label">По договору</div>
            <div class="stat-value" id="teacher_contract_display">0 ₽</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">По формуле 3.9</div>
            <div class="stat-value" id="teacher_formula_display">0 ₽</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Разница</div>
            <div class="stat-value" id="teacher_delta_display">0 ₽</div>
          </div>
        </div>
        <div class="stat-card teacher-overview" aria-live="polite">
          <div class="teacher-row">
            <span class="teacher-label">O_teacher_contract</span>
            <span class="teacher-badge" id="teacher_contract_chip">0 ₽</span>
          </div>
          <div class="teacher-row">
            <span class="teacher-label">O_teacher_calc</span>
            <span class="teacher-badge" id="teacher_calc_chip">0 ₽</span>
          </div>
          <div class="teacher-row">
            <span class="teacher-label">Delta_teacher</span>
            <span class="teacher-badge" id="teacher_delta_chip">0 ₽</span>
          </div>
        </div>
      </div>
    </section>

    <section>
      <h2>Разовые замены <span class="info" tabindex="0" data-tooltip="Укажите часы замещений, численность класса и коэффициенты из приказов на замещение или локальных актов.">?</span></h2>
      <div class="checkbox-row">
        <input id="use_substitution" type="checkbox">
        <label for="use_substitution" style="margin:0">Учитывать замещающие уроки</label>
      </div>
      <div class="sub-grid" id="substitution_block">
        <div class="field">
          <label for="h_subst">Часы замещения в месяц</label>
          <div class="input-with-unit">
            <input id="h_subst" type="number" min="0" step="1">
            <span class="unit-badge">ч/мес</span>
          </div>
        </div>
        <div class="field">
          <label for="n_students">Количество учеников в классе/группе</label>
          <div class="input-with-unit">
            <input id="n_students" type="number" min="1" max="25" step="1">
            <span class="unit-badge">учеников</span>
          </div>
        </div>
        <div class="field">
          <label for="k_corr">K_corr: коэффициент за работу с детьми с умственной отсталостью <span class="info" tabindex="0" data-tooltip="Повышающий коэффициент за коррекционность. Обычно 1.2–1.4.">?</span></label>
          <div class="input-with-unit">
            <input id="k_corr" type="number" min="0" step="0.05">
            <span class="unit-badge">коэфф.</span>
          </div>
        </div>
        <div class="field">
          <label for="k_subst">K_subst: коэффициент за замещение отсутствующего учителя <span class="info" tabindex="0" data-tooltip="Оплата за фактическое замещение. Обычно 1.05–1.2.">?</span></label>
          <div class="input-with-unit">
            <input id="k_subst" type="number" min="0" step="0.05">
            <span class="unit-badge">коэфф.</span>
          </div>
        </div>
        <div class="field">
          <label for="k_usl_subst">Коэффициент условий труда (замещение) <span class="info" tabindex="0" data-tooltip="Особые условия при замещении. Обычно 1.0–1.2.">?</span></label>
          <div class="input-with-unit">
            <input id="k_usl_subst" type="number" min="0" step="0.05">
            <span class="unit-badge">коэфф.</span>
          </div>
        </div>
        <div class="field">
          <label for="u_value">Стоимость ученика-часа, ₽</label>
          <div class="input-with-unit">
            <input id="u_value" type="number" min="0" step="1">
            <span class="unit-badge">₽/ученико-час</span>
          </div>
        </div>
      </div>
      <div id="substitution_warning" class="warning-text" aria-live="polite"></div>
      <div class="checkbox-row" style="margin-top:4px">
        <input id="use_extra_subst" type="checkbox">
        <label for="use_extra_subst" style="margin:0">Учитывать дополнительное замещение</label>
      </div>
      <div class="sub-grid" id="extra_subst_block">
        <div class="field">
          <label for="h_sub_extra">Дополнительные часы (H_sub_extra)</label>
          <div class="input-with-unit">
            <input id="h_sub_extra" type="number" min="0" step="1">
            <span class="unit-badge">ч/мес</span>
          </div>
        </div>
        <div class="field">
          <label>Режим ставки (Subst_rate_mode)</label>
          <div class="flex-row" role="radiogroup" aria-labelledby="subst_rate_mode">
            <label><input type="radio" name="subst_rate_mode" value="order"> По приказу</label>
            <label><input type="radio" name="subst_rate_mode" value="student_hour"> По ученико-часу</label>
          </div>
        </div>
        <div class="field">
          <label for="r_sub_extra">Ставка по приказу (R_sub_extra), ₽</label>
          <div class="input-with-unit">
            <input id="r_sub_extra" type="number" min="0" step="1">
            <span class="unit-badge">₽/урок</span>
          </div>
        </div>
        <div class="field">
          <label for="n_class_subst">Численность класса для расчёта</label>
          <div class="input-with-unit">
            <input id="n_class_subst" type="number" min="0" step="1">
            <span class="unit-badge">учеников</span>
          </div>
        </div>
        <div class="field">
          <label for="class_type_subst">Тип класса (Class_type_subst)</label>
          <select id="class_type_subst">
            <option value="regular">Обычный</option>
            <option value="correctional">Коррекционный</option>
          </select>
        </div>
      </div>
    </section>

    <section>
      <h2>Компенсации</h2>
      <div class="checkbox-row">
        <input id="use_compensations" type="checkbox" checked>
        <label for="use_compensations" style="margin:0">Учитывать компенсационные выплаты</label>
      </div>
      <div class="field">
        <label>OVZ_base_mode: база для расчёта компенсации <span class="info" tabindex="0" data-tooltip="Выберите, от какого оклада считать процент за работу с ОВЗ: только логопедический или логопедический вместе с учительским.">?</span></label>
        <div class="flex-row" role="radiogroup" aria-label="OVZ_base_mode">
          <label><input type="radio" name="ovz_base_mode" value="logoped"> Логопедический</label>
          <label><input type="radio" name="ovz_base_mode" value="combined"> Логопедический + учительский</label>
        </div>
      </div>
      <div class="sub-grid">
        <div class="field" style="margin-bottom:0">
          <label for="k_ovz">% K_OVZ (0–20) <span class="info" tabindex="0" data-tooltip="Процентная доплата за работу с обучающимися с ОВЗ в соответствии с положением об оплате труда.">?</span></label>
          <div class="input-with-unit">
            <input id="k_ovz" type="number" min="0" max="20" step="0.1">
            <span class="unit-badge">%</span>
          </div>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="comp_other">Прочие компенсации (Comp_other), ₽</label>
          <div class="input-with-unit">
            <input id="comp_other" type="number" min="0" step="100">
            <span class="unit-badge">₽/мес</span>
          </div>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="comp_ovz">Компенсация за ОВЗ (Comp_OVZ), ₽</label>
          <div class="input-with-unit">
            <input id="comp_ovz" type="number" readonly>
            <span class="unit-badge">₽/мес</span>
          </div>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="comp_total">Итоговые компенсации (Comp_total), ₽</label>
          <div class="input-with-unit">
            <input id="comp_total" type="number" readonly>
            <span class="unit-badge">₽/мес</span>
          </div>
        </div>
      </div>
    </section>

    <section>
      <h2>Стимулирующие выплаты</h2>
      <div class="checkbox-row">
        <input id="use_stim" type="checkbox" checked>
        <label for="use_stim" style="margin:0">Учитывать стимулирующие выплаты</label>
      </div>
      <div id="stim_block">
        <div class="sub-grid">
          <div class="field" style="margin-bottom:0">
            <label for="stim_part1">Стабильная стимулирующая (Stim_month) <span class="info" tabindex="0" data-tooltip="Ежемесячная фиксированная стимулирующая выплата (в т.ч. стабильная выплата 2025/2026).">?</span></label>
            <div class="input-with-unit">
              <input id="stim_part1" type="number" min="0" step="100">
              <span class="unit-badge">₽/мес</span>
            </div>
          </div>
          <div class="field" style="margin-bottom:0">
            <label for="stim_part2">Стимулирующая часть 2, ₽</label>
            <div class="input-with-unit">
              <input id="stim_part2" type="number" min="0" step="100">
              <span class="unit-badge">₽/мес</span>
            </div>
          </div>
          <div class="field" style="margin-bottom:0">
            <label for="stim_part3">Стимулирующая часть 3, ₽</label>
            <div class="input-with-unit">
              <input id="stim_part3" type="number" min="0" step="100">
              <span class="unit-badge">₽/мес</span>
            </div>
          </div>
        </div>
        <div class="field" style="margin-top:10px">
          <label for="stim_total">Stim_total, ₽</label>
          <div class="input-with-unit">
            <input id="stim_total" type="number" readonly>
            <span class="unit-badge">₽/мес</span>
          </div>
        </div>
      </div>
    </section>

    <section>
      <h2>Налоги и удержания</h2>
      <div class="sub-grid">
        <div class="field" style="margin-bottom:0">
          <label for="ndfl_rate">Ставка НДФЛ, %</label>
          <div class="input-with-unit">
            <input id="ndfl_rate" type="number" min="0" max="100" step="0.1">
            <span class="unit-badge">%</span>
          </div>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="other_withholdings">Прочие удержания, ₽</label>
          <div class="input-with-unit">
            <input id="other_withholdings" type="number" min="0" step="100">
            <span class="unit-badge">₽/мес</span>
          </div>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="ndfl_amount">Ndfl_amount, ₽</label>
          <div class="input-with-unit">
            <input id="ndfl_amount" type="number" readonly>
            <span class="unit-badge">₽</span>
          </div>
        </div>
        <div class="field" style="margin-bottom:0">
          <label for="total_withhold">Total_withhold, ₽</label>
          <div class="input-with-unit">
            <input id="total_withhold" type="number" readonly>
            <span class="unit-badge">₽</span>
          </div>
        </div>
      </div>
    </section>

    <section>
      <h2>Помощь и нормативные документы</h2>
      <details>
        <summary>Открыть справку</summary>
        <div class="accordion-content">
          <p>Ключевые подсказки для корректного ввода данных:</p>
          <ul>
            <li>Проверьте актуальность стоимости ученико-часа и коэффициентов по последнему приказу учреждения.</li>
            <li>Для замещений уточняйте коэффициенты K_corr и K_subst в локальных актах (обычно 1.05–1.2).</li>
            <li>Ставку НДФЛ и удержания вводите в соответствии с персональными условиями сотрудника.</li>
          </ul>
          <p class="muted">Приказ об оплате труда, Положение о стимулирующих и локальные нормативные акты школы помогут быстро заполнить форму.</p>
        </div>
      </details>
    </section>

    <section>
      <h2>Итоги и расшифровка</h2>
      <details open>
        <summary>Краткие итоги</summary>
        <div class="accordion-content" id="totals_breakdown"></div>
      </details>
      <details>
        <summary>Оклад логопеда</summary>
        <div class="accordion-content" id="logoped_breakdown"></div>
      </details>
      <details>
        <summary>Учебная нагрузка</summary>
        <div class="accordion-content" id="teacher_breakdown"></div>
      </details>
      <details>
        <summary>Разовые замены</summary>
        <div class="accordion-content" id="substitution_breakdown"></div>
      </details>
      <details>
        <summary>Компенсации</summary>
        <div class="accordion-content" id="comp_breakdown"></div>
      </details>
      <details>
        <summary>Стимулирующие выплаты</summary>
        <div class="accordion-content" id="stim_breakdown"></div>
      </details>
      <details>
        <summary>Налоги и удержания</summary>
        <div class="accordion-content" id="taxes_breakdown"></div>
      </details>
      <div class="buttons">
        <button class="btn-secondary" id="reset_btn" type="button">Сбросить к значениям по умолчанию</button>
        <button class="btn-primary" id="copy_btn" type="button">Скопировать результат</button>
      </div>
    </section>
  </div>

  <script>
    function mergeDescribedBy(control, id) {
      if (!control || !id) return;
      const existing = (control.getAttribute('aria-describedby') || '').split(/\s+/).filter(Boolean);
      if (!existing.includes(id)) {
        existing.push(id);
        control.setAttribute('aria-describedby', existing.join(' '));
      }
    }

    function applyAriaLabels() {
      document.querySelectorAll('input, select, textarea').forEach((control) => {
        if (control.getAttribute('aria-label')) return;
        if (!control.id) return;
        const label = document.querySelector(`label[for="${control.id}"]`);
        if (!label) return;
        const text = label.textContent.replace(/\?/g, '').trim();
        if (text) {
          control.setAttribute('aria-label', text);
        }
      });
    }

    function enhanceTooltips() {
      document.querySelectorAll('.info[data-tooltip]').forEach((tip, index) => {
        const label = tip.closest('label, h2');
        const controlId = label?.getAttribute('for');
        const hintId = `${controlId || 'tooltip'}_${index}_hint`;
        const hint = document.createElement('span');
        hint.id = hintId;
        hint.className = 'sr-only';
        hint.textContent = tip.dataset.tooltip;
        tip.setAttribute('title', tip.dataset.tooltip);
        tip.setAttribute('role', 'note');
        tip.setAttribute('aria-label', tip.dataset.tooltip);
        tip.setAttribute('tabindex', tip.getAttribute('tabindex') || '0');
        label?.appendChild(hint);
        if (controlId) {
          const control = document.getElementById(controlId);
          mergeDescribedBy(control, hintId);
        }
      });
    }

    const defaults = {
      inputs: {
        period: '2025/2026',
        organization: 'ГБОУ Школа № 1400',
        worker_category: 'Иные педагогические работники (логопед/дефектолог)',
        c_stu: 37,
        weeks_year: 34,
        months_year: 12,
        t_logoped: 65400,
        logoped_share: 1.0,
        use_teacher_load: true,
        a1: 4,
        a2: 0,
        a3: 0,
        o_teacher_contract: 31869.33,
        use_substitution: false,
        h_subst: 16,
        n_students: 10,
        k_corr: 1.25,
        k_subst: 1.15,
        k_usl_subst: 1.05,
        u_value: 37,
        use_extra_subst: false,
        h_sub_extra: 0,
        subst_rate_mode: 'order',
        r_sub_extra: 700,
        n_class_subst: 10,
        class_type_subst: 'correctional',
        use_compensations: true,
        ovz_base_mode: 'combined',
        k_ovz: 20,
        comp_other: 0,
        use_stim: true,
        stim_part1: 6000,
        stim_part2: 0,
        stim_part3: 0,
        ndfl_rate: 13,
        other_withholdings: 0,
      },
      teacherLines: [
        { id: crypto.randomUUID(), subject: 'География (6-р)',             t_week: 2, k_div: 6.25, k_subj: 1.1 },
        { id: crypto.randomUUID(), subject: 'Природоведение (6-р)',        t_week: 2, k_div: 6.25, k_subj: 1.0 },
        { id: crypto.randomUUID(), subject: 'Русский язык (6-р)',          t_week: 4, k_div: 6.25, k_subj: 1.2 },
        { id: crypto.randomUUID(), subject: 'Литературное чтение (6-р)',   t_week: 4, k_div: 6.25, k_subj: 1.0 },
      ],
    };

    const inputs = {
      period: document.getElementById('period'),
      organization: document.getElementById('organization'),
      worker_category: document.getElementById('worker_category'),
      c_stu: document.getElementById('c_stu'),
      weeks_year: document.getElementById('weeks_year'),
      months_year: document.getElementById('months_year'),
      t_logoped: document.getElementById('t_logoped'),
      logoped_share: document.getElementById('logoped_share'),
      use_teacher_load: document.getElementById('use_teacher_load'),
      a1: document.getElementById('a1'),
      a2: document.getElementById('a2'),
      a3: document.getElementById('a3'),
      o_teacher_contract: document.getElementById('o_teacher_contract'),
      use_substitution: document.getElementById('use_substitution'),
      h_subst: document.getElementById('h_subst'),
      n_students: document.getElementById('n_students'),
      k_corr: document.getElementById('k_corr'),
      k_subst: document.getElementById('k_subst'),
      k_usl_subst: document.getElementById('k_usl_subst'),
      u_value: document.getElementById('u_value'),
      use_extra_subst: document.getElementById('use_extra_subst'),
      h_sub_extra: document.getElementById('h_sub_extra'),
      r_sub_extra: document.getElementById('r_sub_extra'),
      n_class_subst: document.getElementById('n_class_subst'),
      class_type_subst: document.getElementById('class_type_subst'),
      use_compensations: document.getElementById('use_compensations'),
      k_ovz: document.getElementById('k_ovz'),
      comp_other: document.getElementById('comp_other'),
      use_stim: document.getElementById('use_stim'),
      stim_part1: document.getElementById('stim_part1'),
      stim_part2: document.getElementById('stim_part2'),
      stim_part3: document.getElementById('stim_part3'),
      ndfl_rate: document.getElementById('ndfl_rate'),
      other_withholdings: document.getElementById('other_withholdings'),
    };

    Object.values(inputs).forEach((input) => {
      if (input?.type === 'number') {
        ensureMessageElement(input);
      }
    });

    const netDisplay = document.getElementById('net_display');
    const grossDisplay = document.getElementById('gross_display');
    const summaryBreakdown = document.getElementById('summary_breakdown');
    const totalsBreakdown = document.getElementById('totals_breakdown');
    const logopedBreakdown = document.getElementById('logoped_breakdown');
    const teacherBreakdown = document.getElementById('teacher_breakdown');
    const teacherContractDisplay = document.getElementById('teacher_contract_display');
    const teacherFormulaDisplay = document.getElementById('teacher_formula_display');
    const teacherDeltaDisplay = document.getElementById('teacher_delta_display');
    const teacherContractChip = document.getElementById('teacher_contract_chip');
    const teacherCalcChip = document.getElementById('teacher_calc_chip');
    const teacherDeltaChip = document.getElementById('teacher_delta_chip');
    const substitutionBreakdown = document.getElementById('substitution_breakdown');
    const compBreakdown = document.getElementById('comp_breakdown');
    const stimBreakdown = document.getElementById('stim_breakdown');
    const taxesBreakdown = document.getElementById('taxes_breakdown');
    const teacherBlock = document.getElementById('teacher_block');
    const teacherLinesContainer = document.getElementById('teacher_lines');
    const addTeacherLineBtn = document.getElementById('add_teacher_line');
    const substitutionBlock = document.getElementById('substitution_block');
    const extraSubstBlock = document.getElementById('extra_subst_block');
    const resetBtn = document.getElementById('reset_btn');
    const copyBtn = document.getElementById('copy_btn');
    const mrotWarning = document.getElementById('mrot_warning');
    const teacherWarning = document.getElementById('teacher_warning');
    const substitutionWarning = document.getElementById('substitution_warning');
    const stimBlock = document.getElementById('stim_block');
    const stimTotalField = document.getElementById('stim_total');
    const ndflAmountField = document.getElementById('ndfl_amount');
    const totalWithholdField = document.getElementById('total_withhold');
    const MROT = 19372;
    const CORRECTION_CLASS_COEF = 1.3;
    const DELTA_CLASSES = ['delta-positive', 'delta-negative'];

    const validationRules = {
      c_stu: { min: 0, max: 1000, step: 1, label: 'C_stu' },
      weeks_year: { min: 1, max: 52, step: 1, label: 'Weeks_year' },
      months_year: { min: 1, max: 12, step: 1, label: 'Months_year' },
      t_logoped: { min: 0, max: 500000, step: 100, label: 'Оклад логопеда' },
      logoped_share: { min: 0, max: 1, step: 0.25, label: 'Доля ставки' },
      o_teacher_contract: { min: 0, max: 500000, step: 100, label: 'O_teacher_contract' },
      a1: { min: 0, max: 40, step: 1, label: 'A1' },
      a2: { min: 0, max: 40, step: 1, label: 'A2' },
      a3: { min: 0, max: 40, step: 1, label: 'A3' },
      h_subst: { min: 0, max: 200, step: 1, label: 'H_subst' },
      n_students: { min: 1, max: 35, step: 1, label: 'N_students' },
      k_corr: { min: 0, max: 3, step: 0.05, label: 'K_corr' },
      k_subst: { min: 0, max: 3, step: 0.05, label: 'K_subst' },
      k_usl_subst: { min: 0, max: 3, step: 0.05, label: 'K_усл_subst' },
      u_value: { min: 0, max: 1000, step: 1, label: 'U' },
      h_sub_extra: { min: 0, max: 200, step: 1, label: 'H_sub_extra' },
      r_sub_extra: { min: 0, max: 20000, step: 50, label: 'R_sub_extra' },
      n_class_subst: { min: 0, max: 35, step: 1, label: 'N_class_subst' },
      k_ovz: { min: 0, max: 100, step: 1, label: 'K_OVZ' },
      comp_other: { min: 0, max: 500000, step: 100, label: 'Comp_other' },
      stim_part1: { min: 0, max: 300000, step: 100, label: 'Stim_part1' },
      stim_part2: { min: 0, max: 300000, step: 100, label: 'Stim_part2' },
      stim_part3: { min: 0, max: 300000, step: 100, label: 'Stim_part3' },
      ndfl_rate: { min: 0, max: 100, step: 0.1, label: 'Ставка НДФЛ' },
      other_withholdings: { min: 0, max: 500000, step: 100, label: 'Прочие удержания' },
    };

    const teacherLineRules = {
      t_week: { min: 0, max: 40, step: 0.25, label: 't_week' },
      k_div: { min: 1, max: 10, step: 0.1, label: 'K_div' },
      k_subj: { min: 1, max: 5, step: 0.1, label: 'K_subj' },
    };

    const inputMessages = {};

    const substRateRadios = document.querySelectorAll('input[name="subst_rate_mode"]');
    const ovzBaseRadios = document.querySelectorAll('input[name="ovz_base_mode"]');
    const compOvzField = document.getElementById('comp_ovz');
    const compTotalField = document.getElementById('comp_total');

    let teacherLines = [];
    let lastSummarySnapshot = null;
    let lastRSubCurrent = 0;

    function formatNumber(value, { minimumFractionDigits = 0, maximumFractionDigits = minimumFractionDigits } = {}) {
      return Number(value).toLocaleString('ru-RU', { minimumFractionDigits, maximumFractionDigits });
    }

    function formatMoney(value) {
      return `${formatNumber(value, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ₽`;
    }

    function formatSignedMoney(value) {
      const sign = value > 0 ? '+' : value < 0 ? '−' : '';
      const absolute = Math.abs(value);
      return `${sign}${formatMoney(absolute)}`;
    }

    function formatPercent(value, { minimumFractionDigits = 1, maximumFractionDigits = minimumFractionDigits } = {}) {
      return `${formatNumber(value, { minimumFractionDigits, maximumFractionDigits })} %`;
    }

    function ensureMessageElement(input) {
      if (inputMessages[input.id]) return inputMessages[input.id];
      const message = document.createElement('div');
      message.id = `${input.id}_message`;
      message.className = 'input-message';
      message.setAttribute('role', 'status');
      message.setAttribute('aria-live', 'polite');
      input.closest('.field')?.appendChild(message);
      mergeDescribedBy(input, message.id);
      inputMessages[input.id] = message;
      return message;
    }

    function snapToStep(value, step) {
      if (!step || step <= 0) return value;
      const snapped = Math.round(value / step) * step;
      return Number(snapped.toFixed(getPrecision(step)));
    }

    function getPrecision(step) {
      const decimals = step.toString().split('.')[1];
      return decimals ? decimals.length : 0;
    }

    function formatStepValue(value, step) {
      const precision = getPrecision(step || 1);
      return Number(value).toFixed(precision).replace(/\.0+$/, '');
    }

    function validateNumber(input, rule) {
      const messageEl = ensureMessageElement(input);
      if (input.disabled) {
        input.classList.remove('invalid');
        messageEl.textContent = '';
        return Number.parseFloat(input.value) || 0;
      }

      const raw = (input.value || '').replace(',', '.');
      let value = Number.parseFloat(raw);
      const messages = [];

      if (raw.trim() === '') {
        messages.push('Заполните поле.');
        value = 0;
      }

      if (!Number.isFinite(value)) {
        messages.push('Используем 0 — не удалось распознать число.');
        value = 0;
      }

      if (rule?.step) {
        const snapped = snapToStep(value, rule.step);
        if (snapped !== value) {
          value = snapped;
          input.value = formatStepValue(value, rule.step);
          messages.push(`Шаг ввода ${rule.step}. Значение скорректировано.`);
        }
      }

      if (rule?.min !== undefined && value < rule.min) {
        value = rule.min;
        input.value = formatStepValue(value, rule.step || 1);
        messages.push(`Минимум ${rule.label || rule.min} — скорректировано.`);
      }

      if (rule?.max !== undefined && value > rule.max) {
        value = rule.max;
        input.value = formatStepValue(value, rule.step || 1);
        messages.push(`Максимум ${rule.label || rule.max} — скорректировано.`);
      }

      if (messages.length) {
        input.classList.add('invalid');
        messageEl.textContent = messages.join(' ');
      } else {
        input.classList.remove('invalid');
        messageEl.textContent = '';
      }

      return value;
    }

    function getValue(id) {
      return validateNumber(inputs[id], validationRules[id]);
    }

    function createUnitBadge(text) {
      const badge = document.createElement('span');
      badge.className = 'unit-badge';
      badge.textContent = text;
      return badge;
    }

    function wrapWithUnit(input, unitText) {
      const wrapper = document.createElement('div');
      wrapper.className = 'input-with-unit';
      wrapper.append(input, createUnitBadge(unitText));
      return wrapper;
    }

    function setDefaults() {
      Object.entries(defaults.inputs).forEach(([key, value]) => {
        const field = inputs[key];
        if (!field) return;
        if (field.type === 'checkbox') {
          field.checked = Boolean(value);
        } else {
          field.value = value;
        }
      });
      substRateRadios.forEach((radio) => {
        radio.checked = radio.value === defaults.inputs.subst_rate_mode;
      });
      ovzBaseRadios.forEach((radio) => {
        radio.checked = radio.value === defaults.inputs.ovz_base_mode;
      });
      resetTeacherLines();
      handleToggles();
      recalc();
    }

    function resetTeacherLines() {
      teacherLines = defaults.teacherLines.map((line) => ({ ...line, id: crypto.randomUUID() }));
      renderTeacherLines();
    }

    function renderTeacherLines() {
      teacherLinesContainer.innerHTML = '';
      teacherLines.forEach((line) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'sub-grid teacher-line';
        wrapper.dataset.lineId = line.id;

        const subjectField = document.createElement('div');
        subjectField.className = 'field';
        const subjectLabel = document.createElement('label');
        subjectLabel.textContent = 'Предмет';
        const subjectInput = document.createElement('input');
        subjectInput.type = 'text';
        subjectInput.id = `${line.id}_subject`;
        subjectInput.value = line.subject;
        subjectLabel.htmlFor = subjectInput.id;
        subjectInput.setAttribute('aria-label', 'Предмет');
        subjectInput.addEventListener('input', (e) => {
          line.subject = e.target.value;
        });
        subjectField.append(subjectLabel, subjectInput);

        const hoursField = document.createElement('div');
        hoursField.className = 'field';
        const hoursLabel = document.createElement('label');
        hoursLabel.textContent = 'Часов в неделю (t_week)';
        const hoursInput = document.createElement('input');
        hoursInput.type = 'number';
        hoursInput.min = '0';
        hoursInput.step = teacherLineRules.t_week.step;
        hoursInput.value = line.t_week;
        hoursInput.id = `${line.id}_t_week`;
        hoursLabel.htmlFor = hoursInput.id;
        hoursInput.addEventListener('input', (e) => {
          line.t_week = validateNumber(hoursInput, teacherLineRules.t_week);
          recalc();
        });
        ensureMessageElement(hoursInput);
        hoursField.append(hoursLabel, wrapWithUnit(hoursInput, 'ч/нед'));

        const kDivField = document.createElement('div');
        kDivField.className = 'field';
        const kDivLabel = document.createElement('label');
        kDivLabel.textContent = 'K_div';
        const kDivInput = document.createElement('input');
        kDivInput.type = 'number';
        kDivInput.min = '1';
        kDivInput.step = teacherLineRules.k_div.step;
        kDivInput.value = line.k_div;
        kDivInput.id = `${line.id}_k_div`;
        kDivLabel.htmlFor = kDivInput.id;
        kDivInput.addEventListener('input', (e) => {
          line.k_div = validateNumber(kDivInput, teacherLineRules.k_div);
          recalc();
        });
        ensureMessageElement(kDivInput);
        kDivField.append(kDivLabel, wrapWithUnit(kDivInput, 'коэфф.'));

        const kSubjField = document.createElement('div');
        kSubjField.className = 'field';
        const kSubjLabel = document.createElement('label');
        kSubjLabel.textContent = 'K_subj';
        const kSubjInput = document.createElement('input');
        kSubjInput.type = 'number';
        kSubjInput.min = '1';
        kSubjInput.step = teacherLineRules.k_subj.step;
        kSubjInput.value = line.k_subj;
        kSubjInput.id = `${line.id}_k_subj`;
        kSubjLabel.htmlFor = kSubjInput.id;
        kSubjInput.addEventListener('input', (e) => {
          line.k_subj = validateNumber(kSubjInput, teacherLineRules.k_subj);
          recalc();
        });
        ensureMessageElement(kSubjInput);
        kSubjField.append(kSubjLabel, wrapWithUnit(kSubjInput, 'коэфф.'));

        const removeField = document.createElement('div');
        removeField.className = 'field';
        const removeLabel = document.createElement('label');
        removeLabel.textContent = 'Удалить строку';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-secondary';
        removeBtn.id = `${line.id}_remove`;
        removeBtn.textContent = 'Удалить';
        removeLabel.htmlFor = removeBtn.id;
        removeBtn.addEventListener('click', () => {
          teacherLines = teacherLines.filter((item) => item.id !== line.id);
          renderTeacherLines();
          recalc();
        });
        removeField.append(removeLabel, removeBtn);

        wrapper.append(subjectField, hoursField, kDivField, kSubjField, removeField);
        teacherLinesContainer.appendChild(wrapper);
      });
      applyAriaLabels();
      handleToggles();
    }

    function handleToggles() {
      const teacherEnabled = inputs.use_teacher_load.checked;
      teacherBlock.classList.toggle('hidden', !teacherEnabled);
      [...teacherBlock.querySelectorAll('input, button')].forEach((el) => {
        if (el.id !== 'use_teacher_load') {
          el.disabled = !teacherEnabled;
        }
      });
      addTeacherLineBtn.disabled = !teacherEnabled;

      const substitutionEnabled = inputs.use_substitution.checked;
      const extraSubstitutionEnabled = inputs.use_extra_subst.checked;
      const shouldEnableUValue = substitutionEnabled || extraSubstitutionEnabled;
      [...substitutionBlock.querySelectorAll('input')].forEach((el) => {
        if (el.id === 'u_value') {
          el.disabled = !shouldEnableUValue;
          return;
        }
        if (el.id !== 'use_substitution') {
          el.disabled = !substitutionEnabled;
        }
      });

      [...extraSubstBlock.querySelectorAll('input, select')].forEach((el) => {
        if (el.id !== 'use_extra_subst') {
          el.disabled = !extraSubstitutionEnabled;
        }
      });

      const compensationEnabled = inputs.use_compensations.checked;
      inputs.k_ovz.disabled = !compensationEnabled;
      inputs.comp_other.disabled = !compensationEnabled;
      compOvzField.disabled = !compensationEnabled;
      compTotalField.disabled = !compensationEnabled;
      ovzBaseRadios.forEach((radio) => {
        radio.disabled = !compensationEnabled;
      });

      const stimEnabled = inputs.use_stim.checked;
      stimBlock.classList.toggle('hidden', !stimEnabled);
      [...stimBlock.querySelectorAll('input')].forEach((el) => {
        el.disabled = !stimEnabled;
      });

      clearMessagesForDisabled();
    }

    function clearMessagesForDisabled() {
      Object.values(inputs).forEach((input) => {
        if (input?.disabled && inputMessages[input.id]) {
          input.classList.remove('invalid');
          inputMessages[input.id].textContent = '';
        }
      });

      document.querySelectorAll('.teacher-line input').forEach((input) => {
        if (input.disabled) {
          input.classList.remove('invalid');
          const message = inputMessages[input.id];
          if (message) message.textContent = '';
        }
      });
    }

    function recalc() {
      const tLogoped = getValue('t_logoped');
      const share = getValue('logoped_share');

      const baseOklad = tLogoped * share;
      const zLogoped = baseOklad;

      const cStu = getValue('c_stu');
      const weeksYear = getValue('weeks_year');
      const monthsYear = getValue('months_year');

      const useTeacher = inputs.use_teacher_load.checked;
      const oTeacherContract = useTeacher ? getValue('o_teacher_contract') : 0;
      const a1 = useTeacher ? getValue('a1') : 0;
      const a2 = useTeacher ? getValue('a2') : 0;
      const a3 = useTeacher ? getValue('a3') : 0;
      const studentSum = a1 + a2 + a3;
      const hasTeacherLoad = useTeacher && (oTeacherContract > 0 || teacherLines.some((line) => (Number(line.t_week) || 0) > 0));

      const teacherCalc = useTeacher ? calculateTeacherLoad(cStu, weeksYear, monthsYear) : { total: 0, lines: [] };

      const useSubst = inputs.use_substitution.checked;
      const hSubst = useSubst ? getValue('h_subst') : 0;
      const nStudents = useSubst ? getValue('n_students') : 0;
      const kCorr = useSubst ? getValue('k_corr') : 0;
      const kSubst = useSubst ? getValue('k_subst') : 0;
      const kUslSubst = useSubst ? getValue('k_usl_subst') : 0;
      const useExtraSubst = inputs.use_extra_subst.checked;
      const uValue = (useSubst || useExtraSubst) ? getValue('u_value') : 0;

      const cHour = useSubst ? uValue * nStudents * kCorr * kSubst * kUslSubst : 0;
      const zSubst = hSubst * cHour;

      const substRateMode = Array.from(substRateRadios).find((radio) => radio.checked)?.value || defaults.inputs.subst_rate_mode;
      const hSubExtra = useExtraSubst ? getValue('h_sub_extra') : 0;
      const rSubExtra = useExtraSubst ? getValue('r_sub_extra') : 0;
      const nClassSubst = useExtraSubst ? getValue('n_class_subst') : 0;
      const classTypeSubst = inputs.class_type_subst.value;
      const classTypeCoef = classTypeSubst === 'correctional' ? CORRECTION_CLASS_COEF : 1;
      const rSubCurrent = useExtraSubst && hSubExtra > 0
        ? (substRateMode === 'order' ? rSubExtra : uValue * nClassSubst * classTypeCoef)
        : 0;
      const zSubstExtra = useExtraSubst && hSubExtra > 0 ? hSubExtra * rSubCurrent : 0;
      lastRSubCurrent = rSubCurrent;

      const substitutionIssues = [];
      if (useSubst && hSubst > 0) {
        if (nStudents <= 0) {
          substitutionIssues.push('Укажите количество учеников для расчёта замещения.');
        }
        if (uValue <= 0) {
          substitutionIssues.push('Стоимость ученико-часа должна быть больше 0 для замещения.');
        }
        if (kCorr === 0 || kSubst === 0 || kUslSubst === 0) {
          substitutionIssues.push('Проверьте коэффициенты замещения — они должны быть выше 0.');
        }
      }
      if (useExtraSubst && hSubExtra > 0) {
        if (substRateMode === 'order' && rSubExtra <= 0) {
          substitutionIssues.push('Для режима «по приказу» введите ставку R_sub_extra выше 0.');
        }
        if (substRateMode === 'student_hour' && (uValue <= 0 || nClassSubst <= 0)) {
          substitutionIssues.push('Для режима «по ученико-часу» задайте стоимость U и численность класса.');
        }
      }
      substitutionWarning.textContent = substitutionIssues.join(' ');

      const useComp = inputs.use_compensations.checked;
      const ovzBaseMode = Array.from(ovzBaseRadios).find((radio) => radio.checked)?.value || defaults.inputs.ovz_base_mode;
      const kOvz = useComp ? getValue('k_ovz') : 0;
      const compOther = useComp ? getValue('comp_other') : 0;
      const ovzBase = ovzBaseMode === 'combined' ? baseOklad + oTeacherContract : baseOklad;
      const compOvz = useComp ? ovzBase * (kOvz / 100) : 0;
      const compTotal = useComp ? compOvz + compOther : 0;
      const zComp = compTotal;

      const useStim = inputs.use_stim.checked;
      const stimPart1 = useStim ? getValue('stim_part1') : 0;
      const stimPart2 = useStim ? getValue('stim_part2') : 0;
      const stimPart3 = useStim ? getValue('stim_part3') : 0;
      const zStim = useStim ? stimPart1 + stimPart2 + stimPart3 : 0;
      stimTotalField.value = zStim.toFixed(2);

      const grossTotal = zLogoped + oTeacherContract + zSubst + zSubstExtra + zComp + zStim;
      const grossSalary = grossTotal;

      const ndflRateRaw = getValue('ndfl_rate');
      const ndflRate = Math.min(100, ndflRateRaw);
      if (ndflRate !== ndflRateRaw) {
        inputs.ndfl_rate.value = ndflRate.toFixed(1).replace(/\.0$/, '');
      }
      const otherWithholdings = getValue('other_withholdings');
      const ndflAmount = grossTotal * (ndflRate / 100);
      const totalWithhold = ndflAmount + otherWithholdings;
      const netTotal = grossTotal - totalWithhold;
      const netSalary = grossSalary > 0 ? netTotal : 0;

      const shareSubstPercent = grossSalary > 0 ? (zSubstExtra / grossSalary) * 100 : null;
      const substHourNet = hSubExtra > 0
        ? (zSubstExtra * (1 - ndflRate / 100)) / hSubExtra
        : null;

      const teacherDelta = teacherCalc.total - oTeacherContract;

      netDisplay.textContent = formatMoney(netSalary);
      grossDisplay.textContent = formatMoney(grossSalary);
      const summaryData = {
        baseOklad: zLogoped,
        teacherContract: oTeacherContract,
        teacherCalc: teacherCalc.total,
        teacherDelta,
        baseSubstitution: zSubst,
        extraSubstitution: zSubstExtra,
        compTotal,
        compOvz,
        compOther,
        stimTotal: zStim,
        ndflRate,
        ndflAmount,
        otherWithholdings,
        totalWithhold,
        grossSalary,
        netSalary,
        shareSubstPercent,
        substHourNet,
      };

      summaryBreakdown.innerHTML = buildSummaryHtml(summaryData);
      totalsBreakdown.innerHTML = buildSummaryHtml(summaryData);
      lastSummarySnapshot = summaryData;

      logopedBreakdown.innerHTML = `
        Формула: Base_logoped = O_logoped_base × S_log<br>
        = ${formatMoney(tLogoped)} × ${formatNumber(share, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>
        = <strong>${formatMoney(zLogoped)}</strong>
      `;

      teacherBreakdown.innerHTML = useTeacher ? `
        По договору: <strong>${formatMoney(oTeacherContract)}</strong><br>
        По формуле: <strong>${formatMoney(teacherCalc.total)}</strong><br>
        Разница: <strong>${formatMoney(teacherDelta)}</strong><br><br>
        ${teacherCalc.lines.join('<br>') || 'Строки нагрузки не указаны.'}
      ` : 'Учебная нагрузка не учитывается.';

      teacherContractDisplay.textContent = formatMoney(oTeacherContract);
      teacherFormulaDisplay.textContent = formatMoney(teacherCalc.total);
      teacherDeltaDisplay.textContent = formatMoney(teacherDelta);
      teacherContractChip.textContent = formatMoney(oTeacherContract);
      teacherCalcChip.textContent = formatMoney(teacherCalc.total);
      teacherDeltaChip.textContent = formatSignedMoney(teacherDelta);
      teacherDeltaChip.classList.remove(...DELTA_CLASSES);
      if (teacherDelta > 0) {
        teacherDeltaChip.classList.add('delta-positive');
      } else if (teacherDelta < 0) {
        teacherDeltaChip.classList.add('delta-negative');
      }

      const baseSubstitutionText = useSubst ? `
        Стоимость часа: C_ч = U × N_учеников × K_corr × K_subst × K_усл_subst<br>
        = ${formatMoney(uValue)} × ${formatNumber(nStudents)} × ${formatNumber(kCorr, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} × ${formatNumber(kSubst, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} × ${formatNumber(kUslSubst, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>
        = <strong>${formatMoney(cHour)}</strong><br><br>
        Итог за месяц: Z_subst = H_subst × C_ч = ${formatNumber(hSubst)} × ${formatMoney(cHour)}<br>
        = <strong>${formatMoney(zSubst)}</strong>
      ` : 'Базовое замещение не учитывается.';

      const extraRateText = substRateMode === 'order'
        ? `Режим «по приказу»: R_sub_current = ${formatMoney(rSubCurrent)}`
        : `Режим «по ученико-часу»: R_sub_current = U × N_class_subst × K_class = ${formatMoney(uValue)} × ${formatNumber(nClassSubst)} × ${formatNumber(classTypeCoef, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} = <strong>${formatMoney(rSubCurrent)}</strong>`;

      const extraSubstitutionText = useExtraSubst ? `
        ${extraRateText}<br><br>
        Subst_extra = H_sub_extra × R_sub_current = ${formatNumber(hSubExtra)} × ${formatMoney(rSubCurrent)}<br>
        = <strong>${formatMoney(zSubstExtra)}</strong>
      ` : 'Дополнительное замещение не учитывается.';

      const substitutionStatsText = `
        Share_subst_percent = ${shareSubstPercent === null ? '—' : `<strong>${formatPercent(shareSubstPercent)}</strong>`}<br>
        Subst_hour_net = ${substHourNet === null ? '—' : `<strong>${formatMoney(substHourNet)}</strong>`}
      `;

      substitutionBreakdown.innerHTML = `${baseSubstitutionText}<br><br>${extraSubstitutionText}<br><br>${substitutionStatsText}`;

      const compText = useComp ? `
        OVZ_base_mode: ${ovzBaseMode === 'combined' ? 'логопедический + учительский' : 'логопедический'}<br>
        Comp_OVZ = Base × K_OVZ = ${formatMoney(ovzBase)} × ${formatPercent(kOvz, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} = <strong>${formatMoney(compOvz)}</strong><br>
        Comp_other = <strong>${formatMoney(compOther)}</strong><br>
        Comp_total = <strong>${formatMoney(compTotal)}</strong>
      ` : 'Компенсации не учитываются.';

      const stimText = useStim ? `
        Стимулирующие части: ${formatMoney(stimPart1)}, ${formatMoney(stimPart2)}, ${formatMoney(stimPart3)}<br>
        Stim_total = <strong>${formatMoney(zStim)}</strong>
      ` : 'Стимулирующие не учитываются.';

      const taxesText = `
        Gross_salary = <strong>${formatMoney(grossSalary)}</strong><br>
        НДФЛ (${formatPercent(ndflRate, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}): <strong>${formatMoney(ndflAmount)}</strong><br>
        Прочие удержания: <strong>${formatMoney(otherWithholdings)}</strong><br>
        Total_withhold = <strong>${formatMoney(totalWithhold)}</strong><br>
        Net_salary = <strong>${formatMoney(netSalary)}</strong>
      `;

      compBreakdown.innerHTML = compText;
      stimBreakdown.innerHTML = stimText;
      taxesBreakdown.innerHTML = taxesText;

      compOvzField.value = compOvz.toFixed(2);
      compTotalField.value = compTotal.toFixed(2);
      ndflAmountField.value = ndflAmount.toFixed(2);
      totalWithholdField.value = totalWithhold.toFixed(2);

      if (baseOklad < MROT && baseOklad > 0) {
        mrotWarning.textContent = `Внимание: расчетный оклад ниже МРОТ (${formatMoney(MROT)}). Проверьте доплаты.`;
      } else {
        mrotWarning.textContent = '';
      }

      if (hasTeacherLoad && studentSum === 0) {
        teacherWarning.textContent = 'Предупреждение: a1 + a2 + a3 = 0 при заданной учебной нагрузке. Уточните численность обучающихся.';
      } else {
        teacherWarning.textContent = '';
      }
    }

    function calculateTeacherLoad(cStu, weeksYear, monthsYear) {
      let total = 0;
      const lines = [];

      teacherLines.forEach((line, index) => {
        const tWeek = Math.max(0, Number(line.t_week) || 0);
        const kDiv = Math.max(1, Number(line.k_div) || 0);
        const kSubj = Math.max(1, Number(line.k_subj) || 0);
        const kTotal = Math.max(0, kDiv + kSubj - 1);
        const oLine = cStu * tWeek * weeksYear / monthsYear * kTotal;
        total += oLine;
        lines.push(`Строка ${index + 1} (${line.subject || 'без названия'}): ${formatMoney(oLine)} (t_week=${formatNumber(tWeek, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, K_div=${formatNumber(kDiv, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, K_subj=${formatNumber(kSubj, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, K_total=${formatNumber(kTotal, { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`);
      });

      return { total, lines };
    }

    function attachListeners() {
      Object.values(inputs).forEach((el) => {
        el.addEventListener('input', () => {
          handleToggles();
          recalc();
        });
        el.addEventListener('change', () => {
          handleToggles();
          recalc();
        });
      });

      substRateRadios.forEach((radio) => {
        radio.addEventListener('change', () => {
          handleToggles();
          recalc();
        });
      });

      ovzBaseRadios.forEach((radio) => {
        radio.addEventListener('change', () => {
          handleToggles();
          recalc();
        });
      });

      resetBtn.addEventListener('click', setDefaults);

      addTeacherLineBtn.addEventListener('click', () => {
        teacherLines.push({ id: crypto.randomUUID(), subject: '', t_week: 0, k_div: 1, k_subj: 1 });
        renderTeacherLines();
        recalc();
      });

      copyBtn.addEventListener('click', async () => {
        const text = buildCopyText(lastSummarySnapshot);
        try {
          await navigator.clipboard.writeText(text);
          copyBtn.textContent = 'Скопировано!';
          setTimeout(() => copyBtn.textContent = 'Скопировать результат', 1500);
        } catch (e) {
          copyBtn.textContent = 'Не удалось скопировать';
          setTimeout(() => copyBtn.textContent = 'Скопировать результат', 1500);
        }
      });
    }

    const testInputs = {
      studentHourRate: () => {
        setDefaults();
        inputs.use_substitution.checked = false;
        inputs.use_extra_subst.checked = true;
        inputs.h_sub_extra.value = 5;
        inputs.u_value.value = 150;
        inputs.n_class_subst.value = 12;
        inputs.class_type_subst.value = 'correctional';
        substRateRadios.forEach((radio) => {
          radio.checked = radio.value === 'student_hour';
        });
        handleToggles();
        recalc();

        const classTypeCoef = inputs.class_type_subst.value === 'correctional' ? CORRECTION_CLASS_COEF : 1;
        const expectedRate = getValue('u_value') * getValue('n_class_subst') * classTypeCoef;

        return {
          name: 'studentHourRate',
          expectedRate,
          actualRate: lastRSubCurrent,
          matches: Math.abs(lastRSubCurrent - expectedRate) < 0.01,
        };
      },
    };

    window.testInputs = testInputs;

    document.addEventListener('DOMContentLoaded', () => {
      enhanceTooltips();
      applyAriaLabels();
      setDefaults();
      attachListeners();
    });

    function buildSummaryHtml(data) {
      return `
        <strong>Оклад логопеда:</strong> ${formatMoney(data.baseOklad)}<br>
        <strong>Учебная нагрузка:</strong> договор — ${formatMoney(data.teacherContract)}, формула — ${formatMoney(data.teacherCalc)}, Δ — ${formatSignedMoney(data.teacherDelta)}<br>
        <strong>Разовые замены:</strong> базовые — ${formatMoney(data.baseSubstitution)}, доп. — ${formatMoney(data.extraSubstitution)}<br>
        <strong>Компенсации:</strong> ${formatMoney(data.compTotal)} (ОВЗ — ${formatMoney(data.compOvz)}, прочие — ${formatMoney(data.compOther)})<br>
        <strong>Стимулирующие:</strong> ${formatMoney(data.stimTotal)}<br>
        <strong>Налоги и удержания:</strong> НДФЛ ${formatPercent(data.ndflRate, { minimumFractionDigits: 0, maximumFractionDigits: 1 })} — ${formatMoney(data.ndflAmount)}, прочие — ${formatMoney(data.otherWithholdings)}, всего — ${formatMoney(data.totalWithhold)}<br>
        <strong>Итоги:</strong> Gross_salary — ${formatMoney(data.grossSalary)}, Net_salary — ${formatMoney(data.netSalary)}<br>
        Доля разовых замен в Gross_salary: <strong>${data.shareSubstPercent === null ? '—' : formatPercent(data.shareSubstPercent)}</strong><br>
        Цена 1 часа доп. замены «на руки»: <strong>${data.substHourNet === null ? '—' : formatMoney(data.substHourNet)}</strong>
      `;
    }

    function buildCopyText(data) {
      if (!data) return '';
      const shareText = data.shareSubstPercent === null ? '—' : formatPercent(data.shareSubstPercent);
      const substNet = data.substHourNet === null ? '—' : formatMoney(data.substHourNet);
      return [
        `На руки: ${formatMoney(data.netSalary)}`,
        `Брутто: ${formatMoney(data.grossSalary)}`,
        `Оклад логопеда: ${formatMoney(data.baseOklad)}`,
        `Учебная нагрузка: договор — ${formatMoney(data.teacherContract)}, формула — ${formatMoney(data.teacherCalc)}, Δ — ${formatSignedMoney(data.teacherDelta)}`,
        `Разовые замены: базовые — ${formatMoney(data.baseSubstitution)}, доп. — ${formatMoney(data.extraSubstitution)}`,
        `Компенсации: ${formatMoney(data.compTotal)} (ОВЗ — ${formatMoney(data.compOvz)}, прочие — ${formatMoney(data.compOther)})`,
        `Стимулирующие: ${formatMoney(data.stimTotal)}`,
        `Налоги: НДФЛ ${formatPercent(data.ndflRate, { minimumFractionDigits: 0, maximumFractionDigits: 1 })} — ${formatMoney(data.ndflAmount)}, прочие — ${formatMoney(data.otherWithholdings)}, всего — ${formatMoney(data.totalWithhold)}`,
        `Итоги: Gross_salary — ${formatMoney(data.grossSalary)}, Net_salary — ${formatMoney(data.netSalary)}`,
        `Доля разовых замен: ${shareText}`,
        `Цена часа доп. замены «на руки»: ${substNet}`,
      ].join('\n');
    }
  </script>
</body>
</html>
